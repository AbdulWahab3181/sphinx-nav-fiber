import{r as o,_ as $,j as l,s as W,b as I,F as Z,aj as Y,g as Ie,aa as Te,ab as De,ac as Re,ad as Ae}from"./index-5fb1066b.js";import{e as Le,m as re,b as N,g as R,u as ge,p as Ge,h as Ue,i as Oe,H as X,k as He,T as he,l as me,n as Fe,L as Be,E as Ve,C as $e,P as We,A as qe,o as Ye,q as Ze,j as Xe,r as Ke,s as Je,V as Qe,B as et,R as ae,O as tt,t as nt}from"./EditIcon-1d71224b.js";import{Y as ot,Z as st,V as b,X as U,$ as xe,aE as rt,aF as it,a9 as at,aa as ct,ab as lt,ac as ut,ae as dt,a6 as ft,ag as pt,aG as ye,aH as gt,aI as ht,aJ as mt,aK as xt,aL as yt,aM as bt,ap as be,u as Se,e as St,f as Ct,C as wt,N as vt}from"./react-toastify.esm-74a6e79d.js";import{u as A,a as S,f as Pt}from"./index-99aacf27.js";import{d as jt}from"./index.esm-a4700a64.js";import{P as _t}from"./PlusIcon-6f90f472.js";import{u as J}from"./index-8c752204.js";const ce=new xe,Q=new rt,le=new it,ee=new b;class kt extends ot{constructor(){super(),this.size=0,this.color=new st("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var t;return(t=this.instance.current)==null?void 0:t.geometry}raycast(t,i){var s,a;const r=this.instance.current;if(!r||!r.geometry)return;const u=r.userData.instances.indexOf(this.instanceKey);if(u===-1||u>r.geometry.drawRange.count)return;const n=(s=(a=t.params.Points)==null?void 0:a.threshold)!==null&&s!==void 0?s:1;if(le.set(this.getWorldPosition(ee),n),t.ray.intersectsSphere(le)===!1)return;ce.copy(r.matrixWorld).invert(),Q.copy(t.ray).applyMatrix4(ce);const c=n/((this.scale.x+this.scale.y+this.scale.z)/3),h=c*c,p=Q.distanceSqToPoint(ee);if(p<h){const d=new b;Q.closestPointToPoint(ee,d),d.applyMatrix4(this.matrixWorld);const g=t.ray.origin.distanceTo(d);if(g<t.near||g>t.far)return;i.push({distance:g,distanceToRay:Math.sqrt(p),point:d,index:u,face:null,object:this})}}}let L,H;const Ce=o.createContext(null),ue=new xe,de=new b,Nt=o.forwardRef(({children:e,range:t,limit:i=1e3,...s},a)=>{const r=o.useRef(null),[u,n]=o.useState([]),[[c,h,p]]=o.useState(()=>[new Float32Array(i*3),Float32Array.from({length:i*3},()=>1),Float32Array.from({length:i},()=>1)]);o.useEffect(()=>{r.current.geometry.attributes.position.needsUpdate=!0}),N(()=>{for(r.current.updateMatrix(),r.current.updateMatrixWorld(),ue.copy(r.current.matrixWorld).invert(),r.current.geometry.drawRange.count=Math.min(i,t!==void 0?t:i,u.length),L=0;L<u.length;L++)H=u[L].current,H.getWorldPosition(de).applyMatrix4(ue),de.toArray(c,L*3),r.current.geometry.attributes.position.needsUpdate=!0,H.matrixWorldNeedsUpdate=!0,H.color.toArray(h,L*3),r.current.geometry.attributes.color.needsUpdate=!0,p.set([H.size],L),r.current.geometry.attributes.size.needsUpdate=!0});const d=o.useMemo(()=>({getParent:()=>r,subscribe:g=>(n(y=>[...y,g]),()=>n(y=>y.filter(w=>w.current!==g.current)))}),[]);return o.createElement("points",$({userData:{instances:u},matrixAutoUpdate:!1,ref:re([a,r]),raycast:()=>null},s),o.createElement("bufferGeometry",null,o.createElement("bufferAttribute",{attach:"attributes-position",count:c.length/3,array:c,itemSize:3,usage:U}),o.createElement("bufferAttribute",{attach:"attributes-color",count:h.length/3,array:h,itemSize:3,usage:U}),o.createElement("bufferAttribute",{attach:"attributes-size",count:p.length,array:p,itemSize:1,usage:U})),o.createElement(Ce.Provider,{value:d},e))}),Et=o.forwardRef(({children:e,...t},i)=>{o.useMemo(()=>Le({PositionPoint:kt}),[]);const s=o.useRef(),{subscribe:a,getParent:r}=o.useContext(Ce);return o.useLayoutEffect(()=>a(s),[]),o.createElement("positionPoint",$({instance:r(),instanceKey:s,ref:re([i,s])},t),e)}),zt=o.forwardRef(({children:e,positions:t,colors:i,sizes:s,stride:a=3,...r},u)=>{const n=o.useRef(null);return N(()=>{const c=n.current.geometry.attributes;c.position.needsUpdate=!0,i&&(c.color.needsUpdate=!0),s&&(c.size.needsUpdate=!0)}),o.createElement("points",$({ref:re([u,n])},r),o.createElement("bufferGeometry",null,o.createElement("bufferAttribute",{attach:"attributes-position",count:t.length/a,array:t,itemSize:a,usage:U}),i&&o.createElement("bufferAttribute",{attach:"attributes-color",count:i.length/a,array:i,itemSize:3,usage:U}),s&&o.createElement("bufferAttribute",{attach:"attributes-size",count:s.length/a,array:s,itemSize:1,usage:U})),e)}),Mt=o.forwardRef((e,t)=>e.positions instanceof Float32Array?o.createElement(zt,$({},e,{ref:t})):o.createElement(Nt,$({},e,{ref:t}))),It=(e,t,i,s,a)=>{const r=new ct,u=1e-5;r.absarc(u,u,u,-Math.PI/2,-Math.PI,!0),r.absarc(u,t-s*2,u,Math.PI,Math.PI/2,!0),r.absarc(e-s*2,t-s*2,u,Math.PI/2,0,!0),r.absarc(e-s*2,u,u,0,-Math.PI/2,!0);const n=new lt(r,{depth:i-s*2,bevelEnabled:!0,bevelSegments:a,steps:2,bevelSize:s,bevelThickness:s,curveSegments:a});n.center();const c=[],h=n.getAttribute("normal"),p=n.getAttribute("position");for(let d=0;d<p.count;d+=1){const g=new b(h.getX(d),h.getY(d),h.getZ(d)),y=new b(p.getX(d),p.getY(d),p.getZ(d));let w=0,P=0;Math.abs(g.y)>.9?(w=y.x/e+.5,P=1-(y.z/i+.5)):Math.abs(g.x)>.9?(w=-y.z/i+.5,P=1-(-y.y/t+.5)):Math.abs(g.z)>.9&&(w=y.x/e+.5,P=1-(-y.y/t+.5)),c.push(w,P)}return n.setAttribute("uv",new ut(c,2)),n};It(10,10,10,2,10);new at(10,10,10);const Tt=500,Dt=800,Rt=new b(0,0,0),At=16777215;let F=null;const Lt=500,ie=(e,t)=>{if(F)return null;F=setTimeout(()=>{F&&(clearTimeout(F),F=null)},Lt);const i=[];return e.forEach(a=>{const r=t.position.distanceTo(Rt.set(a.x,a.y,a.z));r<Dt&&i.push({id:a.ref_id||"",distance:r})}),i.sort((a,r)=>a.distance-r.distance).slice(0,Tt).map(a=>a.id)},D=new b(0,0,0),fe=100,Gt=600,Ut=2e3,te={x:172.7392402058252,y:-239.04675366094037,z:-2e3};let G,B;const Ot=4e3,Ht=2e3,Ft=e=>{const t=A(),i=S(m=>m.cameraFocusTrigger),s=R(m=>m.isUserDragging),a=R(m=>m.isUserScrolling),r=R(m=>m.setUserMovedCamera),u=S(m=>m.setNearbyNodeIds),n=S(m=>m.showSelectionGraph),c=S(m=>m.data),h=S(m=>m.graphStyle),{camera:p}=ge(),[d,g]=o.useState(!1),[y,w]=o.useState(!1),[P,E]=o.useState(fe),f=o.useMemo(()=>{if(n)return new b(0,0,0);const m=c==null?void 0:c.nodes.find(M=>M.ref_id===(t==null?void 0:t.ref_id));let j=new b(2e3,2e3,3e3);if(m&&c){const M=[],O=new b(m.x,m.y,m.z);let K=new b(0,0,0);M.map(q=>(K=K.add(new b(q.x,q.y,q.z).normalize()),q));const ze=m.edge_count?1-1/(m.edge_count+10):1,Me=O.sub(K).multiplyScalar(.8*ze);j=O.add(Me)}return j},[n,t,c]),v=o.useMemo(()=>{if(n)return new b(0,0,0);const m=c==null?void 0:c.nodes.find(j=>j.ref_id===(t==null?void 0:t.ref_id));return new b((m==null?void 0:m.x)||0,(m==null?void 0:m.y)||0,(m==null?void 0:m.z)||0)},[n,t,c]);o.useEffect(()=>{var m;n&&((m=e.current)==null||m.setLookAt(te.x,te.y,te.z,0,0,0,!1)),_()},[n]),o.useEffect(()=>{n?E(Ut):(t==null?void 0:t.node_type)==="topic"?E(Gt):E(fe)},[t,E,n]),o.useEffect(()=>{x()},[i]),o.useEffect(()=>{(s||a)&&(g(!0),w(!0))},[s,a,g,w]),o.useEffect(()=>{if(t)if(!n&&h==="earth"&&(e!=null&&e.current)){const m=e.current.camera.position.distanceTo(new b),j=dt(v,-m/2);e.current.setLookAt(j.x,j.y,j.z,0,0,0,!0)}else G&&clearTimeout(G),G=setTimeout(()=>{w(!0),clearTimeout(G)},Ht),_();return()=>{G&&clearTimeout(G),B&&clearTimeout(B)}},[t]),N(m=>{e.current&&(d||C(f,m.camera),y||z(v,m.camera))});const _=()=>{if(t){const m=p.position.distanceTo(f);Ge(m)}x()},x=()=>{g(!1),w(!1),r(!1),B&&clearTimeout(B),B=setTimeout(()=>{g(!0),w(!0)},Ot)},C=(m,j)=>{if(j.position.distanceTo(m)<P)g(!0);else{j.position.lerp(m,.5);const O=ie((c==null?void 0:c.nodes)||[],p);O&&u(O)}},z=(m,j)=>{var M;(M=e==null?void 0:e.current)==null||M.setLookAt(j.position.x,j.position.y,j.position.z,m.x,m.y,m.z,!0)};return null},Bt=1;let T=null;const Vt=(e,{enabled:t})=>{const i=A();Ft(e);const s=R(p=>p.isUserDragging),a=S(p=>p.disableCameraRotation),r=S(p=>p.data),u=S(p=>p.graphStyle),n=S(p=>p.graphRadius),c=S(p=>p.setNearbyNodeIds);o.useEffect(()=>{t||(T==null||T.kill(),T=null)},[t]);const h=o.useCallback(()=>{T==null||T.kill();const p={value:-244},d=Ue.to(p,{duration:5,keyframes:{"0%":{value:10},"100%":{delay:2,ease:"Power4.easeIn",value:-200}},onComplete:()=>{T=null},onInterrupt(){d.kill()},onUpdate:()=>{var y;const{value:g}=p;if(e.current){const w=ie((r==null?void 0:r.nodes)||[],e.current.camera);w&&c(w),(y=e.current)==null||y.dolly(g,!1)}}});d.play(),T=d},[]);return o.useEffect(()=>{e.current&&n&&(u==="sphere"?(e.current.maxDistance=8e3,e.current.minDistance=200,e.current.setTarget(0,0,500,!0)):(e.current.maxDistance=e.current.getDistanceToFitSphere(n+200),e.current.minDistance=100))},[n,u,e]),o.useEffect(()=>{h()},[h,u]),o.useEffect(()=>{!i&&e.current&&e.current.setLookAt(D.x,D.y,D.z,0,0,0,!0)},[i]),N((p,d)=>{e.current&&(!a&&!s&&(e.current.azimuthAngle+=Bt*d*ft.DEG2RAD),e.current.update(d))}),null},$t=({disableAnimations:e})=>{const t=o.useRef(null),i=S(g=>g.graphStyle),s=S(g=>g.data),a=S(g=>g.setNearbyNodeIds),r=S(g=>g.setDisableCameraRotation),[u]=o.useState(.8),{camera:n}=ge(),[c,h,p,d]=R(g=>[g.isUserDragging,g.setIsUserDragging,g.isUserScrolling,g.isUserScrollingOnHtmlPanel]);return Vt(t,{enabled:!e&&!p&&!c}),o.useEffect(()=>{t.current&&t.current.setLookAt(D.x,D.y,D.z,0,0,0,!0)},[i]),o.useEffect(()=>{if(!c){const g=ie((s==null?void 0:s.nodes)||[],n);g&&a(g)}},[n,n.position,n.position.x,n.position.y,n.position.z,s==null?void 0:s.nodes,a,c]),o.useEffect(()=>{c&&r(!0)},[c,r]),l.jsx(Oe,{ref:t,boundaryEnclosesCamera:!0,enabled:!d,makeDefault:!0,maxDistance:12e3,minDistance:100,onEnd:()=>h(!1),onStart:()=>h(!0),smoothTime:u})},Wt=["#ffffff","#ffffcc","#ccffcc","#ffccff","#ccccff","#ffd699","#c2f0c2","#ff6666","#99ccff","#ffb3b3"],qt=new b,Yt=({position:e,userData:t})=>{const i=o.useRef(null),[s,a]=S(n=>[n.selectedNode,n.nodeTypes]),r=S(n=>n.showSelectionGraph);return N(()=>{if(r&&i.current){const n=qt.set((t==null?void 0:t.x)||0,(t==null?void 0:t.y)||0,(t==null?void 0:t.z)||0);i.current.position.copy(n)}}),o.useEffect(()=>function(){i.current&&i.current.clear()},[i]),(s==null?void 0:s.ref_id)===(t==null?void 0:t.ref_id)?null:l.jsx("group",{ref:i,position:e,children:l.jsx(X,{center:!0,sprite:!0,zIndexRange:[0,0],children:l.jsx(Zt,{bgColor:Wt[Math.max(a.indexOf(t.node_type),0)],children:t.node_type})})})},we=o.memo(()=>{const e=S(r=>r.data),t=S(r=>r.showSelectionGraph),i=S(r=>r.selectionGraphData),s=S(r=>r.selectedNodeRelativeIds),a=o.useMemo(()=>(t?i.nodes:(e==null?void 0:e.nodes)||[]).filter(c=>s.includes((c==null?void 0:c.ref_id)||"")).slice(0,pt).map(c=>{const h=new b((c==null?void 0:c.x)||0,(c==null?void 0:c.y)||0,(c==null?void 0:c.z)||0),p=[];return l.jsx(Yt,{position:h,relativeIds:p,userData:c},`node-badge-${c.ref_id}`)}),[s,e==null?void 0:e.nodes,t,i]);return l.jsx(o.Fragment,{children:a.length?a:null},"node-badges")});we.displayName="RelevanceBadges";const Zt=W.div`
  position: absolute;
  left: 50%;
  top: 20%;
  transform: translateX(-50%) translateY(200%);
  padding: 0 4px;
  height: 14px;
  background: ${e=>e.bgColor};
  color: ${I.BG1};
  font-size: 8px;
  font-style: normal;
  font-weight: 800;
  line-height: 14px;
`,ve=e=>l.jsx("svg",{width:"1em",height:"1em",viewBox:"0 0 20 20",fill:"currentColor",xmlns:"http://www.w3.org/2000/svg",children:l.jsxs("g",{id:"delete",children:[l.jsx("mask",{id:"mask0_2401_3378",maskUnits:"userSpaceOnUse",x:"0",y:"0",width:"20",height:"20",children:l.jsx("rect",{id:"Bounding box",width:"1em",height:"1em",fill:"currentColor"})}),l.jsx("g",{children:l.jsx("path",{id:"delete_2",d:"M6.08975 17.0834C5.67415 17.0834 5.31919 16.9362 5.02485 16.6419C4.73051 16.3475 4.58333 15.9926 4.58333 15.577V5.00009H4.375C4.19765 5.00009 4.04915 4.94026 3.9295 4.82061C3.80983 4.70095 3.75 4.55245 3.75 4.37511C3.75 4.19776 3.80983 4.04926 3.9295 3.92961C4.04915 3.80994 4.19765 3.75011 4.375 3.75011H7.49998C7.49998 3.54605 7.57183 3.37218 7.71552 3.22848C7.85922 3.08479 8.03309 3.01294 8.23715 3.01294H11.7628C11.9669 3.01294 12.1407 3.08479 12.2844 3.22848C12.4281 3.37218 12.5 3.54605 12.5 3.75011H15.625C15.8023 3.75011 15.9508 3.80994 16.0705 3.92961C16.1901 4.04926 16.25 4.19776 16.25 4.37511C16.25 4.55245 16.1901 4.70095 16.0705 4.82061C15.9508 4.94026 15.8023 5.00009 15.625 5.00009H15.4166V15.577C15.4166 15.9926 15.2695 16.3475 14.9751 16.6419C14.6808 16.9362 14.3258 17.0834 13.9102 17.0834H6.08975ZM14.1666 5.00009H5.83331V15.577C5.83331 15.6518 5.85735 15.7132 5.90544 15.7613C5.95352 15.8094 6.01496 15.8334 6.08975 15.8334H13.9102C13.985 15.8334 14.0464 15.8094 14.0945 15.7613C14.1426 15.7132 14.1666 15.6518 14.1666 15.577V5.00009ZM7.83654 14.1668H9.08652V6.66675H7.83654V14.1668ZM10.9134 14.1668H12.1634V6.66675H10.9134V14.1668Z",fill:"currentColor"})})]})}),Xt=({position:e,title:t,onRemove:i})=>{const s=o.useRef(null);return o.useEffect(()=>function(){s.current&&s.current.clear()},[s]),l.jsx("group",{ref:s,position:e,children:l.jsx(X,{center:!0,sprite:!0,children:l.jsxs(Kt,{direction:"row",justify:"center",onClick:a=>{a.stopPropagation()},onPointerOut:a=>{a.stopPropagation()},onPointerOver:a=>{a.stopPropagation()},children:[l.jsx("span",{children:t}),l.jsx(Z,{className:"icon",onClick:i,children:l.jsx(ve,{})})]})})})},Kt=W(Z)`
  text-align: center;

  outline-offset: 0px;
  background: rgba(0, 0, 0, 0.75);
  color: #eee;
  cursor: pointer;
  transition: font-size 0.4s, outline 0.4s;
  align-items: center;
  justify-content: center;
  font-family: Barlow;
  font-size: 16px;
  font-style: normal;
  font-weight: 700;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);

  &:hover {
    outline-offset: 4px;
    span {
      opacity: 0.1;
    }

    .icon {
      display: flex;
    }
  }

  .icon {
    position: absolute;
    width: 24px;
    height: 24px;
    /* bottom: 100%; */
    display: none;
    color: #000;
    border-radius: 40px;
    justify-content: center;
    align-items: center;
    background: #ffffff;
    color: #000;
    border-radius: 100%;
    font-size: 16px;
    cursor: pointer;
    transition: opacity 0.4s;
    box-shadow: 0px 2px 12px rgba(0, 0, 0, 0.5);
  }

  .badge-wrapper {
    position: absolute;
    top: -7px;
    left: -14px;
  }
`,Jt=(e,t)=>{const i=e.reduce((a,r,u)=>{if(u<e.length-1){const n=e[u+1],c=new b().subVectors(n,r).length();return a+c}return a},0);let s=0;for(let a=0;a<e.length-1;a+=1){const r=e[a],u=e[a+1],n=new b().subVectors(u,r).length();if(t<=(s+n)/i){const c=(t*i-s)/n;return new b().lerpVectors(r,u,c)}s+=n}return e[e.length-1]},Qt=({link:e,title:t,onRemove:i})=>{const s=o.useRef(null),a=o.useRef(null),r=A(),[u,n]=o.useState(new b(0,0,0)),[c,h]=o.useState(new b(0,0,0)),[p,d]=o.useState("#ff13c9"),[g]=S(x=>[x.selectionGraphData]),[y,w]=o.useState(0);N(()=>{w(x=>(x+.01)%1)}),o.useEffect(()=>{var x,C,z,m,j,M;n(new b(((x=e.sourcePosition)==null?void 0:x.x)||0,((C=e.sourcePosition)==null?void 0:C.y)||0,((z=e.sourcePosition)==null?void 0:z.z)||0)),h(new b(((m=e.targetPosition)==null?void 0:m.x)||0,((j=e.targetPosition)==null?void 0:j.y)||0,((M=e.targetPosition)==null?void 0:M.z)||0)),d("#ff13c9")},[r,e]);const P=new b().addVectors(u,c).multiplyScalar(.5);N(()=>{if(s.current){const x=g.nodes.find(z=>z.ref_id===e.source),C=g.nodes.find(z=>z.ref_id===e.target);s.current.start.set((x==null?void 0:x.x)||0,(x==null?void 0:x.y)||0,(x==null?void 0:x.z)||0),s.current.end.set((C==null?void 0:C.x)||0,(C==null?void 0:C.y)||0,(C==null?void 0:C.z)||0),n(new b((x==null?void 0:x.x)||0,(x==null?void 0:x.y)||0,(x==null?void 0:x.z)||0)),h(new b((C==null?void 0:C.x)||0,(C==null?void 0:C.y)||0,(C==null?void 0:C.z)||0))}});const E=new b(0,0,0),f=![e.target,e.source].includes((r==null?void 0:r.ref_id)||""),v=new ye(u,E,c),_=f?v.getPoints(2):[u,c];return l.jsxs(l.Fragment,{children:[l.jsx(He,{ref:s,color:"transparent",end:c,start:u}),l.jsxs(Mt,{limit:1,range:1,children:[l.jsx("pointsMaterial",{vertexColors:!0}),l.jsx(Et,{ref:a,color:p,position:Jt(_,y),size:20})]}),l.jsx(Xt,{onRemove:i,position:P,title:t})]})},en={font:"/fonts/Inter-Bold.woff",characters:"abcdefghijklmnopqrstuvwxyz0123456789!",fontSize:8,letterSpacing:-.05,lineHeight:1,"material-toneMapped":!1},Pe=o.memo(({node:e})=>{const t=o.useRef(null),i=A(),a=S(h=>h.selectedNodeRelativeIds).includes((e==null?void 0:e.ref_id)||""),r=!!i&&(i==null?void 0:i.ref_id)===e.ref_id,u=S(h=>h.showSelectionGraph);N(({camera:h})=>{t!=null&&t.current&&(t.current.quaternion.copy(h.quaternion),u&&t.current.position.set(e.x,e.y,e.z))});const n=o.useMemo(()=>((e.edge_count||1)*4,(e.edge_count||1)*4),[e.edge_count,r,a,u]),c=o.useMemo(()=>1,[r,i,a]);return l.jsx(he,{ref:t,anchorX:"center",anchorY:"middle",color:I.white,fillOpacity:c,position:[e.x,e.y,e.z],scale:Math.min(n,10),userData:e,visible:!0,...en,children:e.name})});Pe.displayName="SelectionNode";const pe=gt().stop(),k={numDimensions:3,velocityDecay:.9,forceChargeStrength:-20,forceChargeMinDistance:150,forceChargeMaxDistance:8e3,forceLinkStrength:.04,forceCenterStrength:.85,disableCollide:!1,disableCenter:!1,disableLink:!1,disableCharge:!1,forceCollideRadiusMethod:e=>((e.edge_count||1)+20)*6+200,forceLinkDistanceMethod:()=>150},tn=(e,t,{numDimensions:i=k.numDimensions,velocityDecay:s=k.velocityDecay,forceChargeStrength:a=k.forceChargeStrength,forceChargeMinDistance:r=k.forceChargeMinDistance,forceChargeMaxDistance:u=k.forceChargeMaxDistance,forceLinkStrength:n=k.forceLinkStrength,forceCenterStrength:c=k.forceCenterStrength,forceLinkDistanceMethod:h=k.forceLinkDistanceMethod,forceCollideRadiusMethod:p=k.forceCollideRadiusMethod,disableCollide:d=k.disableCollide,disableCenter:g=k.disableCenter,disableLink:y=k.disableLink,disableCharge:w=k.disableCharge})=>(pe.alpha(1).stop().numDimensions(i).velocityDecay(s).force("collide",d?null:ht().radius(p).iterations(1)).force("center",g?null:mt().strength(c)).force("charge",w?null:xt().strength(a).distanceMin(r).distanceMax(u)).nodes(e).force("link",y?null:yt().distance(h).strength(n).id(P=>P.ref_id)).alpha(1).restart(),pe);let ne=null;const je=o.memo(()=>{const e=A(),[t,i,s]=S(n=>[n.data,n.selectedNodeRelativeIds,n.removeLink]),[a,r]=S(n=>[n.selectionGraphData,n.setSelectionData]);o.useEffect(()=>{if(a.nodes.length>0)return;const n=((t==null?void 0:t.nodes)||[]).filter(p=>i.includes(p.ref_id)||p.ref_id===(e==null?void 0:e.ref_id)).map(p=>{const d=p.ref_id===(e==null?void 0:e.ref_id)?{fx:0,fy:0,fz:0}:{};return{...p,x:0,y:0,z:0,...d}}),c=(t==null?void 0:t.links.filter(p=>n.some(d=>d.ref_id===p.target)&&n.some(d=>d.ref_id===p.source)))||[];r({nodes:n,links:c})},[t,e,i,a.nodes.length,r]),o.useEffect(()=>{ne=tn([...a.nodes],[...a.links],{numDimensions:2,forceLinkStrength:.1,forceCenterStrength:.1,forceChargeStrength:20,velocityDecay:.9})},[a]),N(()=>{ne&&ne.tick()});const u=n=>{const c=n.target===(e==null?void 0:e.ref_id)?n.source:n.target,h=a.nodes.filter(d=>d.ref_id!==c),p=a.links.filter(d=>d.ref_id!==n.ref_id);r({nodes:h,links:p}),s(n.ref_id,c)};return l.jsxs(l.Fragment,{children:[l.jsx(me,{fog:!0,lineWidth:.9,children:a.links.map(n=>l.jsx(Qt,{link:n,onRemove:()=>u(n),title:n.edge_type},n.ref_id))},`selection-links-${a==null?void 0:a.links.length}`),a.nodes.map(n=>l.jsx(Pe,{node:n},`${n.ref_id}-compact`))]})});je.displayName="SelectionDataNodes";const nn={font:"/fonts/Inter-Bold.woff",characters:"abcdefghijklmnopqrstuvwxyz0123456789!",fontSize:2,letterSpacing:-.05,lineHeight:1,"material-toneMapped":!1},_e=o.memo(({node:e,hide:t})=>{const i=o.useRef(null),s=A(),[a,r]=S(y=>[y.selectedNodeRelativeIds,y.nodeTypes]),u=a.includes((e==null?void 0:e.ref_id)||""),n=!!s&&(s==null?void 0:s.ref_id)===e.ref_id,c=S(y=>y.showSelectionGraph);N(({camera:y})=>{i!=null&&i.current&&(i.current.quaternion.copy(y.quaternion),c&&i.current.position.set(e.x,e.y,e.z))});const h=o.useMemo(()=>((e.edge_count||1)*4,(e.edge_count||1)*4),[e.edge_count,n,u,c]),p=o.useMemo(()=>s&&!n&&!u?.1:1,[n,s,u]),d=Y[r.indexOf(e.node_type)]||Y[0],g=s?(s==null?void 0:s.ref_id)===e.ref_id:!0;return l.jsx(he,{ref:i,anchorX:"center",anchorY:"middle",color:d,fillOpacity:p,position:[e.x,e.y,e.z],scale:Math.min(h,10),userData:e,visible:!t&&g,...nn,children:e.name})});_e.displayName="TextNode";const ke=o.memo(()=>{const[e,t,i,s,a,r]=S(d=>[d.data,d.selectedNode,d.setHoveredNode,d.showSelectionGraph,d.selectionGraphData,d.setSelectedNode]),u=o.useCallback(d=>!!(s&&!a.nodes.find(g=>g.ref_id===d.ref_id)),[s,a]),n=o.useCallback(d=>{const g=d==null?void 0:d[0];g&&g.userData&&(u(g.userData)||r((g==null?void 0:g.userData)||null))},[u,r]),c=o.useCallback(d=>{d.stopPropagation(),i(null)},[i]),h=o.useCallback(d=>{var w;const y=d.intersections.map(P=>P.object)[0];if((w=y==null?void 0:y.userData)!=null&&w.ref_id){const P=y.userData;u(P)||(d.stopPropagation(),i(P))}},[i,u]),p=s&&!!t;return l.jsxs(Fe,{filter:d=>d.filter(g=>{var y;return!!((y=g.userData)!=null&&y.ref_id)}),onChange:n,onPointerOut:c,onPointerOver:h,children:[s&&l.jsx(we,{}),e==null?void 0:e.nodes.map(d=>l.jsx(_e,{hide:p,node:d},d.ref_id)),p&&l.jsx(je,{},t.ref_id)]})});ke.displayName="Cubes";const on=({link:e,animated:t})=>{var P,E;const i=A(),[s,a]=o.useState(new b(0,0,0)),[r,u]=o.useState(new b(0,0,0)),[n]=o.useState(Y[0]),c=S(f=>f.nodesNormalized);o.useEffect(()=>{var f,v,_,x,C,z;a(new b(((f=e.sourcePosition)==null?void 0:f.x)||0,((v=e.sourcePosition)==null?void 0:v.y)||0,((_=e.sourcePosition)==null?void 0:_.z)||0)),u(new b(((x=e.targetPosition)==null?void 0:x.x)||0,((C=e.targetPosition)==null?void 0:C.y)||0,((z=e.targetPosition)==null?void 0:z.z)||0))},[i,e]);const h=new b(0,1,0),p=new ye(s,h,r),d=((P=c[e.source])==null?void 0:P.node_type)!==((E=c[e.target])==null?void 0:E.node_type),g=d?Y[1]:n,y=d?p.getPoints(50):[s,r],w=!i||i.ref_id===e.source||i.ref_id===e.target;return l.jsx(Be,{color:g,opacity:.1,points:y.map(f=>f.toArray()),transparent:!0,visible:w})},V=e=>({close:{backgroundColor:"rgba(48, 51, 66, 1)",borderColor:"#fff",fontColor:"rgba(255, 255, 255, 1)"},focus:{backgroundColor:e?"rgba(255, 255, 255, 0.90);":"rgba(255, 255, 255, 0.90)",borderColor:e?"#FFDB58bb":"#fff",fontColor:"rgba(48, 51, 66, 1)"},menu:{backgroundColor:"#00000066",borderColor:e?"#ffffff66":"#5078f2",fontColor:e?"#ffffff66":"#fff"}}),sn=new b,Ne=o.memo(()=>{const e=o.useRef(null),{open:t}=J("editNodeName"),{open:i}=J("removeNode"),{open:s}=J("addEdgeToNode"),[a]=Ie(f=>[f.isAdmin]),r=S(f=>f.showSelectionGraph),[u,n,c,h]=S(f=>[f.selectionGraphData,f.setSelectionData,f.selectedNodeRelativeIds,f.setSelectedNodeRelativeIds]),[p]=S(f=>[f.data,f.setData]),d=A(),g=S(f=>f.setSelectedNode),y=S(f=>f.setShowSelectionGraph);N(()=>{P()});const w=o.useCallback(async()=>{try{if(d!=null&&d.ref_id){const f=await Pt(d==null?void 0:d.ref_id,u.nodes.length||0),v=((f==null?void 0:f.edges)||[]).filter(x=>!u.links.some(C=>x.target===C.target&&x.source===C.source)),_=((f==null?void 0:f.nodes)||[]).filter(x=>!u.nodes.some(C=>x.ref_id===C.ref_id));n({links:[...u.links,...v.map(x=>({...x,sourcePosition:new b,targetPosition:new b}))],nodes:[...u.nodes,..._.map(x=>({...x,x:0,y:0,z:0}))]}),h([...new Set([...c,..._.map(x=>x.ref_id)])])}}catch(f){console.log(f)}},[d==null?void 0:d.ref_id,c,u.links,u.nodes,h,n]),P=o.useCallback(()=>{const f=r?u:p;if(e.current){const v=f==null?void 0:f.nodes.find(_=>_.ref_id===(d==null?void 0:d.ref_id));if(v){const _=sn.set(v==null?void 0:v.x,v==null?void 0:v.y,v==null?void 0:v.z);e.current.position.copy(_)}}},[d,r,u,p]),E=o.useMemo(()=>{const f=[{key:"control-key-1",colors:V(r).focus,icon:l.jsx(_t,{}),left:-80,className:"add",onClick:()=>{s()}},{key:"control-key-2",colors:V(r).focus,icon:l.jsx(Ve,{}),left:-40,className:"edit",onClick:()=>{t()}},{key:"control-key-3",colors:V(r).focus,icon:l.jsx(ve,{}),left:0,className:"delete",onClick:()=>{i()}}],v=[{key:"control-key-5",colors:V(!0).close,icon:l.jsx(bt,{}),left:40,className:"exit",onClick:()=>{w()}},{key:"control-key-6",colors:V(!0).close,icon:l.jsx(jt,{}),left:40,className:"exit",onClick:()=>{g(null),y(!1)}}];return[...f,...v].map((_,x)=>({..._,left:-80+x*40}))},[a,r,s,t,i,y,g,w]);return d?l.jsx("group",{ref:e,children:l.jsx(X,{center:!0,className:"control-panel",onClick:f=>f.stopPropagation(),onKeyDown:f=>f.stopPropagation(),onPointerDown:f=>f.stopPropagation(),onPointerOut:f=>f.stopPropagation(),onPointerOver:f=>f.stopPropagation(),onPointerUp:f=>f.stopPropagation(),sprite:!0,zIndexRange:[16777271,16777272],children:E.map(f=>l.jsx(rn,{backgroundColor:f.colors.backgroundColor,borderColor:f.colors.borderColor,className:f.className,fontColor:f.colors.fontColor,left:f.left,onClick:v=>{v.stopPropagation(),f.onClick()},children:f.icon},f.key))})}):null});Ne.displayName="NodeControls";const rn=W.div`
  position: fixed;
  top: -60px;
  left: ${e=>-7+e.left}px;
  width: 24px;
  height: 24px;

  border-radius: 40px;
  display: flex;
  justify-content: center;
  align-items: center;
  background: ${e=>e.backgroundColor?e.backgroundColor:"#000000bb"};
  color: ${e=>e.fontColor?e.fontColor:"#ffffff"};
  border-radius: 100%;
  font-size: 16px;
  cursor: pointer;
  transition: opacity 0.4s;
  box-shadow: 0px 2px 12px rgba(0, 0, 0, 0.5);
`,Ee=o.memo(()=>l.jsx(l.Fragment,{children:l.jsx(Ne,{})}));Ee.displayName="NodeDetailsPanel";const an=()=>{const[e,t,i,s,a]=S(n=>[n.data,n.isFetching,n.graphStyle,n.showSelectionGraph,n.selectionGraphData]),r=o.useMemo(()=>s?0:i==="force"?.2:.4,[s,i]),u=o.useMemo(()=>((s?a.links:e==null?void 0:e.links)||[]).map(h=>l.jsx(on,{link:h},h.source)),[e==null?void 0:e.links,a.links,s]);return t?null:l.jsxs(l.Fragment,{children:[l.jsx(ke,{}),!1,!s&&l.jsx(me,{fog:!0,limit:u.length,lineWidth:r,children:u},`links-${u.length}-${i}`),l.jsx(Ee,{}),!1]})},oe=5e3,cn=()=>{const{fogColor:e}=be("universe",{fogColor:Re}),t=Se(r=>r.graphStyle),i=o.useRef(null),s=o.useRef(null),a=o.useRef(null);return N(({camera:r,clock:u})=>{const n=u.getElapsedTime();if(i.current){const h=Math.sin(n/8)*1e3;i.current.position.setZ(h)}if(s.current&&s.current.position.lerp(r.position,.5),a.current){const c=n*.5,h=Math.sin(c)*oe,p=Math.cos(c)*oe;a.current.position.set(h,0,p)}}),l.jsxs(l.Fragment,{children:[l.jsx("hemisphereLight",{args:[I.white,Te,De]}),t!=="earth"&&l.jsx("fog",{args:[e,5,18e3],attach:"fog"}),l.jsx("ambientLight",{color:I.white,intensity:1}),l.jsx("pointLight",{ref:s,color:I.white,distance:4e3,intensity:5,position:[0,0,0]}),l.jsx("directionalLight",{ref:a,color:I.white,intensity:8,position:[oe,0,0]}),l.jsx("pointLight",{ref:i,color:I.white,distance:4e3,intensity:8,position:[0,0,0]})]})},ln=({fullSize:e=!0})=>{const t=St(i=>i.sidebarIsOpen);return l.jsx(un,{align:"center",className:Ct({"sidebar-is-open":t&&!e}),justify:"center",children:l.jsx(wt,{color:I.SECONDARY_BLUE,size:64})})},un=W(Z)`
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  top: 0;
  background-color: ${I.black};
  z-index: 1;
`,dn=()=>l.jsx(X,{children:l.jsx(Ze,{})}),fn=()=>{const{universeColor:e}=be("universe",{universeColor:I.black}),t=vt(),i=o.useMemo(()=>t!=null&&t.node_type?Xe(t.node_type):At,[t]);return l.jsxs(l.Fragment,{children:[l.jsx("color",{args:[e],attach:"background"}),l.jsx(cn,{}),l.jsx($t,{}),l.jsxs(Ke,{children:[l.jsxs(Je,{autoClear:!1,multisampling:8,children:[l.jsx(Qe,{darkness:.7,eskil:!1,offset:.05}),l.jsx(et,{luminanceThreshold:1,mipmapBlur:!0,resolutionX:ae.AUTO_SIZE,resolutionY:ae.AUTO_SIZE}),l.jsx(tt,{blendFunction:nt.SCREEN,blur:!0,edgeStrength:4,hiddenEdgeColor:i,visibleEdgeColor:i})]}),l.jsx(an,{})]})]})};let se=null;const pn={aspect:window.innerWidth/window.innerHeight,far:3e4,near:1,position:[D.x,D.y,D.z]},gn=()=>{const[e,t,i]=[R(u=>u.setIsUserScrollingOnHtmlPanel),R(u=>u.setIsUserScrolling),R(u=>u.setUserMovedCamera)],s=Se(u=>u.isFetching),a=o.useCallback(u=>{var h;const{target:n}=u,{offsetParent:c}=n;se&&clearTimeout(se),(h=c==null?void 0:c.classList)!=null&&h.contains("html-panel")&&c.clientHeight<c.scrollHeight&&e(!0),t(!0),i(!0),se=setTimeout(()=>{t(!1),e(!1)},200)},[t,e,i]),r=o.useCallback(u=>Ae(u,"threeState"),[]);return l.jsxs(hn,{children:[l.jsx(o.Suspense,{fallback:null,children:l.jsx($e,{camera:pn,id:"universe-canvas",onCreated:r,onWheel:a,children:l.jsxs(o.Suspense,{fallback:l.jsx(dn,{}),children:[l.jsx(We,{}),l.jsx(qe,{}),l.jsx(Ye,{}),l.jsx(fn,{})]})})}),s&&l.jsx(ln,{fullSize:!1})]})},hn=W(Z)`
  flex: 1 1 100%;
  position: relative;
`,vn=o.memo(gn);export{vn as Universe};
