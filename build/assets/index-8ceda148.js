import{o as it,p as at,s as fe,a as G,E as co,r as g,_ as ct,j as n,v as lt,q as ue,n as dt,t as Yt,D as lo,f as Ue,h as ut,x as wt,J as uo,K as po,bI as pt,Q as L,a5 as q,U as E,ar as Ve,S as F,bL as fo,bM as et,bN as ho,bH as Gt,ad as Ht,ax as Fe,bF as ge,ba as jt,b9 as vt,b8 as Et,b7 as Pt,b6 as mo,b3 as go,by as Ct}from"./index-4f150300.js";import{r as bo,k as xo,a$ as yo,b0 as wo,af as ft,aP as Le,aQ as jo,aK as We,B as Se,ag as Kt,ai as pe,ac as Zt,b1 as vo,ae as Eo,b2 as Tt,aA as Po,D as Co,P as To,b3 as Xt,b4 as Oo,c as qt,aG as So}from"./index-2ed354cc.js";import{p as st,c as Ao,g as Mo}from"./index-44e303ef.js";import{g as ko,m as $o,u as ne,b as Ye,t as rt,T as Qt,i as Jt,H as _o,j as Ot,C as Io,P as No,k as zo}from"./index-72bf4ab5.js";import{Z as Ro,_ as Bo,E as Do,V as I,$ as he,a0 as me,a1 as St,P as Re,a2 as Be,a3 as At,a as te,a4 as Vo,G as Fo,C as Lo}from"./three.module-2ce81f73.js";import{A as Mt}from"./AddContentIcon-446d0f86.js";function Wo(t){return it("PrivateSwitchBase",t)}at("PrivateSwitchBase",["root","checked","disabled","input","edgeStart","edgeEnd"]);const Uo=["autoFocus","checked","checkedIcon","className","defaultChecked","disabled","disableFocusRipple","edge","icon","id","inputProps","inputRef","name","onBlur","onChange","onFocus","readOnly","required","tabIndex","type","value"],Yo=t=>{const{classes:o,checked:s,disabled:e,edge:a}=t,c={root:["root",s&&"checked",e&&"disabled",a&&`edge${ue(a)}`],input:["input"]};return dt(c,Wo,o)},Go=fe(bo)(({ownerState:t})=>G({padding:9,borderRadius:"50%"},t.edge==="start"&&{marginLeft:t.size==="small"?-3:-12},t.edge==="end"&&{marginRight:t.size==="small"?-3:-12})),Ho=fe("input",{shouldForwardProp:co})({cursor:"inherit",position:"absolute",opacity:0,width:"100%",height:"100%",top:0,left:0,margin:0,padding:0,zIndex:1}),Ko=g.forwardRef(function(o,s){const{autoFocus:e,checked:a,checkedIcon:c,className:u,defaultChecked:i,disabled:l,disableFocusRipple:w=!1,edge:d=!1,icon:h,id:f,inputProps:m,inputRef:b,name:y,onBlur:P,onChange:C,onFocus:v,readOnly:M,required:k=!1,tabIndex:j,type:x,value:T}=o,$=ct(o,Uo),[B,O]=xo({controlled:a,default:!!i,name:"SwitchBase",state:"checked"}),D=yo(),J=H=>{v&&v(H),D&&D.onFocus&&D.onFocus(H)},N=H=>{P&&P(H),D&&D.onBlur&&D.onBlur(H)},V=H=>{if(H.nativeEvent.defaultPrevented)return;const de=H.target.checked;O(de),C&&C(H,de)};let U=l;D&&typeof U>"u"&&(U=D.disabled);const ee=x==="checkbox"||x==="radio",Q=G({},o,{checked:B,disabled:U,disableFocusRipple:w,edge:d}),X=Yo(Q);return n.jsxs(Go,G({component:"span",className:lt(X.root,u),centerRipple:!0,focusRipple:!w,disabled:U,tabIndex:null,role:void 0,onFocus:J,onBlur:N,ownerState:Q,ref:s},$,{children:[n.jsx(Ho,G({autoFocus:e,checked:a,defaultChecked:i,className:X.input,disabled:U,id:ee?f:void 0,name:y,onChange:V,readOnly:M,ref:b,required:k,ownerState:Q,tabIndex:j,type:x},x==="checkbox"&&T===void 0?{}:{value:T},m)),B?c:h]}))}),Zo=Ko,Xo=g.createContext(),kt=Xo;function qo(t){return it("MuiGrid",t)}const Qo=[0,1,2,3,4,5,6,7,8,9,10],Jo=["column-reverse","column","row-reverse","row"],en=["nowrap","wrap-reverse","wrap"],Te=["auto",!0,1,2,3,4,5,6,7,8,9,10,11,12],tn=at("MuiGrid",["root","container","item","zeroMinWidth",...Qo.map(t=>`spacing-xs-${t}`),...Jo.map(t=>`direction-xs-${t}`),...en.map(t=>`wrap-xs-${t}`),...Te.map(t=>`grid-xs-${t}`),...Te.map(t=>`grid-sm-${t}`),...Te.map(t=>`grid-md-${t}`),...Te.map(t=>`grid-lg-${t}`),...Te.map(t=>`grid-xl-${t}`)]),Oe=tn,on=["className","columns","columnSpacing","component","container","direction","item","rowSpacing","spacing","wrap","zeroMinWidth"];function be(t){const o=parseFloat(t);return`${o}${String(t).replace(String(o),"")||"px"}`}function nn({theme:t,ownerState:o}){let s;return t.breakpoints.keys.reduce((e,a)=>{let c={};if(o[a]&&(s=o[a]),!s)return e;if(s===!0)c={flexBasis:0,flexGrow:1,maxWidth:"100%"};else if(s==="auto")c={flexBasis:"auto",flexGrow:0,flexShrink:0,maxWidth:"none",width:"auto"};else{const u=Ue({values:o.columns,breakpoints:t.breakpoints.values}),i=typeof u=="object"?u[a]:u;if(i==null)return e;const l=`${Math.round(s/i*1e8)/1e6}%`;let w={};if(o.container&&o.item&&o.columnSpacing!==0){const d=t.spacing(o.columnSpacing);if(d!=="0px"){const h=`calc(${l} + ${be(d)})`;w={flexBasis:h,maxWidth:h}}}c=G({flexBasis:l,flexGrow:0,maxWidth:l},w)}return t.breakpoints.values[a]===0?Object.assign(e,c):e[t.breakpoints.up(a)]=c,e},{})}function sn({theme:t,ownerState:o}){const s=Ue({values:o.direction,breakpoints:t.breakpoints.values});return ut({theme:t},s,e=>{const a={flexDirection:e};return e.indexOf("column")===0&&(a[`& > .${Oe.item}`]={maxWidth:"none"}),a})}function eo({breakpoints:t,values:o}){let s="";Object.keys(o).forEach(a=>{s===""&&o[a]!==0&&(s=a)});const e=Object.keys(t).sort((a,c)=>t[a]-t[c]);return e.slice(0,e.indexOf(s))}function rn({theme:t,ownerState:o}){const{container:s,rowSpacing:e}=o;let a={};if(s&&e!==0){const c=Ue({values:e,breakpoints:t.breakpoints.values});let u;typeof c=="object"&&(u=eo({breakpoints:t.breakpoints.values,values:c})),a=ut({theme:t},c,(i,l)=>{var w;const d=t.spacing(i);return d!=="0px"?{marginTop:`-${be(d)}`,[`& > .${Oe.item}`]:{paddingTop:be(d)}}:(w=u)!=null&&w.includes(l)?{}:{marginTop:0,[`& > .${Oe.item}`]:{paddingTop:0}}})}return a}function an({theme:t,ownerState:o}){const{container:s,columnSpacing:e}=o;let a={};if(s&&e!==0){const c=Ue({values:e,breakpoints:t.breakpoints.values});let u;typeof c=="object"&&(u=eo({breakpoints:t.breakpoints.values,values:c})),a=ut({theme:t},c,(i,l)=>{var w;const d=t.spacing(i);return d!=="0px"?{width:`calc(100% + ${be(d)})`,marginLeft:`-${be(d)}`,[`& > .${Oe.item}`]:{paddingLeft:be(d)}}:(w=u)!=null&&w.includes(l)?{}:{width:"100%",marginLeft:0,[`& > .${Oe.item}`]:{paddingLeft:0}}})}return a}function cn(t,o,s={}){if(!t||t<=0)return[];if(typeof t=="string"&&!Number.isNaN(Number(t))||typeof t=="number")return[s[`spacing-xs-${String(t)}`]];const e=[];return o.forEach(a=>{const c=t[a];Number(c)>0&&e.push(s[`spacing-${a}-${String(c)}`])}),e}const ln=fe("div",{name:"MuiGrid",slot:"Root",overridesResolver:(t,o)=>{const{ownerState:s}=t,{container:e,direction:a,item:c,spacing:u,wrap:i,zeroMinWidth:l,breakpoints:w}=s;let d=[];e&&(d=cn(u,w,o));const h=[];return w.forEach(f=>{const m=s[f];m&&h.push(o[`grid-${f}-${String(m)}`])}),[o.root,e&&o.container,c&&o.item,l&&o.zeroMinWidth,...d,a!=="row"&&o[`direction-xs-${String(a)}`],i!=="wrap"&&o[`wrap-xs-${String(i)}`],...h]}})(({ownerState:t})=>G({boxSizing:"border-box"},t.container&&{display:"flex",flexWrap:"wrap",width:"100%"},t.item&&{margin:0},t.zeroMinWidth&&{minWidth:0},t.wrap!=="wrap"&&{flexWrap:t.wrap}),sn,rn,an,nn);function dn(t,o){if(!t||t<=0)return[];if(typeof t=="string"&&!Number.isNaN(Number(t))||typeof t=="number")return[`spacing-xs-${String(t)}`];const s=[];return o.forEach(e=>{const a=t[e];if(Number(a)>0){const c=`spacing-${e}-${String(a)}`;s.push(c)}}),s}const un=t=>{const{classes:o,container:s,direction:e,item:a,spacing:c,wrap:u,zeroMinWidth:i,breakpoints:l}=t;let w=[];s&&(w=dn(c,l));const d=[];l.forEach(f=>{const m=t[f];m&&d.push(`grid-${f}-${String(m)}`)});const h={root:["root",s&&"container",a&&"item",i&&"zeroMinWidth",...w,e!=="row"&&`direction-xs-${String(e)}`,u!=="wrap"&&`wrap-xs-${String(u)}`,...d]};return dt(h,qo,o)},pn=g.forwardRef(function(o,s){const e=Yt({props:o,name:"MuiGrid"}),{breakpoints:a}=lo(),c=wo(e),{className:u,columns:i,columnSpacing:l,component:w="div",container:d=!1,direction:h="row",item:f=!1,rowSpacing:m,spacing:b=0,wrap:y="wrap",zeroMinWidth:P=!1}=c,C=ct(c,on),v=m||b,M=l||b,k=g.useContext(kt),j=d?i||12:k,x={},T=G({},C);a.keys.forEach(O=>{C[O]!=null&&(x[O]=C[O],delete T[O])});const $=G({},c,{columns:j,container:d,direction:h,item:f,rowSpacing:v,columnSpacing:M,wrap:y,zeroMinWidth:P,spacing:b},x,{breakpoints:a.keys}),B=un($);return n.jsx(kt.Provider,{value:j,children:n.jsx(ln,G({ownerState:$,className:lt(B.root,u),as:w,ref:s},T))})}),le=pn;function fn(t){return it("MuiSwitch",t)}const hn=at("MuiSwitch",["root","edgeStart","edgeEnd","switchBase","colorPrimary","colorSecondary","sizeSmall","sizeMedium","checked","disabled","input","thumb","track"]),K=hn,mn=["className","color","edge","size","sx"],gn=t=>{const{classes:o,edge:s,size:e,color:a,checked:c,disabled:u}=t,i={root:["root",s&&`edge${ue(s)}`,`size${ue(e)}`],switchBase:["switchBase",`color${ue(a)}`,c&&"checked",u&&"disabled"],thumb:["thumb"],track:["track"],input:["input"]},l=dt(i,fn,o);return G({},o,l)},bn=fe("span",{name:"MuiSwitch",slot:"Root",overridesResolver:(t,o)=>{const{ownerState:s}=t;return[o.root,s.edge&&o[`edge${ue(s.edge)}`],o[`size${ue(s.size)}`]]}})(({ownerState:t})=>G({display:"inline-flex",width:34+12*2,height:14+12*2,overflow:"hidden",padding:12,boxSizing:"border-box",position:"relative",flexShrink:0,zIndex:0,verticalAlign:"middle","@media print":{colorAdjust:"exact"}},t.edge==="start"&&{marginLeft:-8},t.edge==="end"&&{marginRight:-8},t.size==="small"&&{width:40,height:24,padding:7,[`& .${K.thumb}`]:{width:16,height:16},[`& .${K.switchBase}`]:{padding:4,[`&.${K.checked}`]:{transform:"translateX(16px)"}}})),xn=fe(Zo,{name:"MuiSwitch",slot:"SwitchBase",overridesResolver:(t,o)=>{const{ownerState:s}=t;return[o.switchBase,{[`& .${K.input}`]:o.input},s.color!=="default"&&o[`color${ue(s.color)}`]]}})(({theme:t})=>({position:"absolute",top:0,left:0,zIndex:1,color:t.vars?t.vars.palette.Switch.defaultColor:`${t.palette.mode==="light"?t.palette.common.white:t.palette.grey[300]}`,transition:t.transitions.create(["left","transform"],{duration:t.transitions.duration.shortest}),[`&.${K.checked}`]:{transform:"translateX(20px)"},[`&.${K.disabled}`]:{color:t.vars?t.vars.palette.Switch.defaultDisabledColor:`${t.palette.mode==="light"?t.palette.grey[100]:t.palette.grey[600]}`},[`&.${K.checked} + .${K.track}`]:{opacity:.5},[`&.${K.disabled} + .${K.track}`]:{opacity:t.vars?t.vars.opacity.switchTrackDisabled:`${t.palette.mode==="light"?.12:.2}`},[`& .${K.input}`]:{left:"-100%",width:"300%"}}),({theme:t,ownerState:o})=>G({"&:hover":{backgroundColor:t.vars?`rgba(${t.vars.palette.action.activeChannel} / ${t.vars.palette.action.hoverOpacity})`:wt(t.palette.action.active,t.palette.action.hoverOpacity),"@media (hover: none)":{backgroundColor:"transparent"}}},o.color!=="default"&&{[`&.${K.checked}`]:{color:(t.vars||t).palette[o.color].main,"&:hover":{backgroundColor:t.vars?`rgba(${t.vars.palette[o.color].mainChannel} / ${t.vars.palette.action.hoverOpacity})`:wt(t.palette[o.color].main,t.palette.action.hoverOpacity),"@media (hover: none)":{backgroundColor:"transparent"}},[`&.${K.disabled}`]:{color:t.vars?t.vars.palette.Switch[`${o.color}DisabledColor`]:`${t.palette.mode==="light"?uo(t.palette[o.color].main,.62):po(t.palette[o.color].main,.55)}`}},[`&.${K.checked} + .${K.track}`]:{backgroundColor:(t.vars||t).palette[o.color].main}})),yn=fe("span",{name:"MuiSwitch",slot:"Track",overridesResolver:(t,o)=>o.track})(({theme:t})=>({height:"100%",width:"100%",borderRadius:14/2,zIndex:-1,transition:t.transitions.create(["opacity","background-color"],{duration:t.transitions.duration.shortest}),backgroundColor:t.vars?t.vars.palette.common.onBackground:`${t.palette.mode==="light"?t.palette.common.black:t.palette.common.white}`,opacity:t.vars?t.vars.opacity.switchTrack:`${t.palette.mode==="light"?.38:.3}`})),wn=fe("span",{name:"MuiSwitch",slot:"Thumb",overridesResolver:(t,o)=>o.thumb})(({theme:t})=>({boxShadow:(t.vars||t).shadows[1],backgroundColor:"currentColor",width:20,height:20,borderRadius:"50%"})),jn=g.forwardRef(function(o,s){const e=Yt({props:o,name:"MuiSwitch"}),{className:a,color:c="primary",edge:u=!1,size:i="medium",sx:l}=e,w=ct(e,mn),d=G({},e,{color:c,edge:u,size:i}),h=gn(d),f=n.jsx(wn,{className:h.thumb,ownerState:d});return n.jsxs(bn,{className:lt(h.root,a),sx:l,ownerState:d,children:[n.jsx(xn,G({type:"checkbox",icon:f,checkedIcon:f,ref:s,ownerState:d},w,{classes:G({},h,{root:h.switchBase})})),n.jsx(yn,{className:h.track,ownerState:d})]})}),vn=jn,En={type:"",parent:""},$t=({onSelect:t,dataTestId:o,edgeLink:s,hideSelectAll:e})=>{const a=ft({mode:"onChange",defaultValues:En}),{watch:c,setValue:u}=a,[i,l]=g.useState([]),[w,d]=g.useState(!1),h=y=>{u("parent",(y==null?void 0:y.value)||""),t(y==null?void 0:y.value)},f=y=>y.charAt(0).toUpperCase()+y.slice(1);g.useEffect(()=>{(async()=>{d(!0);try{const C=(await pt()).schemas.filter(M=>!M.is_deleted&&M.type).map(M=>(M==null?void 0:M.type)==="thing"?{label:"No Parent",value:M.type}:{label:f(M.type),value:M.type});l(e?C:[{label:"Select all",value:"all"},...C]),s&&u("parent",s)}catch(P){console.warn(P)}finally{d(!1)}})()},[s,u,e]);const m=c("parent"),b=()=>{const y=i==null?void 0:i.find(P=>P.value===m);if(y)return y;if(s)return{label:s,value:s}};return n.jsx(Le,{dataTestId:o,disabled:!!s,isLoading:w,onSelect:h,options:i||jo,selectedValue:b()})},Pn=({selectedType:t,setSelectedFromNode:o,setSelectedToNode:s,edgeLinkData:e,selectedFromNode:a,selectedToNode:c})=>{const u=c==="all",i=a==="all";return n.jsxs(E,{children:[n.jsx(E,{align:"center",direction:"row",justify:"space-between",mb:35,children:n.jsx(E,{align:"center",direction:"row",children:n.jsx(Cn,{children:e!=null&&e.refId?"Edit Edge":"Add Edge"})})}),n.jsxs(E,{mb:25,children:[n.jsx(E,{mb:12,children:n.jsx(q,{children:"Source"})}),n.jsx($t,{dataTestId:"from_node",edgeLink:e==null?void 0:e.source,hideSelectAll:u,onSelect:o})]}),n.jsxs(E,{mb:10,children:[n.jsx(E,{mb:12,children:n.jsx(q,{children:"Edge Name"})}),n.jsx(E,{mb:12,children:n.jsx(We,{id:"cy-item-name",maxLength:250,name:"type",placeholder:"Enter type name",rules:{...Ve},value:t})})]}),n.jsxs(E,{mb:25,children:[n.jsx(E,{mb:12,children:n.jsx(q,{children:"Destination"})}),n.jsx($t,{dataTestId:"to_node",edgeLink:e==null?void 0:e.target,hideSelectAll:i,onSelect:s})]})]})},Cn=L(q)`
  font-size: 22px;
  font-weight: 600;
`,Tn=({onCancel:t,edgeLinkData:o,setGraphLoading:s})=>{var x,T,$;const e=ft({mode:"onChange"}),{setValue:a,getValues:c}=e,[u,i]=g.useState(!1),[l,w]=g.useState(!1),[d,h]=g.useState(""),[f,m]=g.useState(""),[b,y]=g.useState(""),P=e.watch("type");g.useEffect(()=>{a("type",o==null?void 0:o.edgeType)},[o==null?void 0:o.edgeType,a]),g.useEffect(()=>{h(P)},[P]);const C=e.handleSubmit(async B=>{i(!0),s(!0);const O={source:f,target:b,edge_type:B.type},D={ref_id:o==null?void 0:o.refId,edge_type:B.type};try{if(o!=null&&o.refId)await fo(D);else if(b&&f)if(f==="all"||b==="all"){const N=(await pt()).schemas.filter(V=>!V.is_deleted&&V.type).map(V=>V.type);f==="all"?await Promise.all(N.map(V=>et({...O,source:V}))):b==="all"&&await Promise.all(N.map(V=>et({...O,target:V})))}else await et(O)}catch(J){console.warn("API Error:",J)}finally{i(!1),s(!1),m(""),y(""),t()}}),v=(T=(x=c())==null?void 0:x.type)==null?void 0:T.trim(),M=v&&(($=o==null?void 0:o.edgeType)==null?void 0:$.trim())!==v,k=o!=null&&o.refId?u||!M:u||!b||!f||!d,j=async()=>{w(!0),s(!0);try{o!=null&&o.refId&&await ho(o==null?void 0:o.refId)}catch(B){console.warn("API Error:",B)}finally{w(!1),s(!1),m(""),y(""),t()}};return n.jsx(Kt,{...e,children:n.jsxs("form",{id:"add-type-form",onSubmit:C,children:[n.jsx(Pn,{edgeLinkData:o,selectedFromNode:f,selectedToNode:b,selectedType:d,setSelectedFromNode:m,setSelectedToNode:y}),n.jsxs(E,{direction:"row",justify:"space-between",mt:20,children:[(o==null?void 0:o.refId)&&n.jsx(E,{direction:"column",children:n.jsxs(Sn,{color:"secondary",disabled:l,onClick:j,size:"large",style:{marginRight:20},variant:"contained",children:["Delete",l&&n.jsxs(_t,{children:[n.jsx(pe,{color:F.lightGray,size:12})," "]})]})}),n.jsxs(On,{color:"secondary",disabled:k,onClick:C,size:"large",variant:"contained",children:["Confirm",u&&n.jsxs(_t,{children:[n.jsx(pe,{color:F.lightGray,size:12})," "]})]})]})]})})},On=L(Se)`
  width: 293px !important;
  margin: 0 0 10px auto !important;
`,_t=L.span`
  margin-top: 2px;
`,Sn=L(Se)`
  && {
    color: ${F.primaryRed};
    background-color: rgba(237, 116, 116, 0.1);

    &:hover,
    &:active,
    &:focus {
      color: ${F.primaryRed};
      background-color: rgba(237, 116, 116, 0.2);
    }
  }
`,An=({setIsAddEdgeNode:t,edgeData:o,setGraphLoading:s})=>{const e=()=>{t(!1)};return n.jsxs(E,{children:[n.jsx(E,{direction:"row",justify:"flex-end",children:n.jsx(Mn,{"data-testid":"close-sidebar-sub-view",onClick:e,children:n.jsx(Zt,{})})}),n.jsx(Tn,{edgeLinkData:o,onCancel:e,setGraphLoading:s})]})},Mn=L(E)`
  font-size: 32px;
  color: ${F.white};
  cursor: pointer;
`,kn=/^[a-z0-9_]+$/,$n=({parentParam:t,onDelete:o})=>{const[s,e]=g.useState(!1),[a,c]=g.useState([]),{fields:u,append:i,replace:l,remove:w}=vo({name:"attributes"}),{setValue:d,watch:h}=Eo();return g.useEffect(()=>{const f=async()=>{try{let m=[{required:!1,type:"string",key:""}];if(t!==Xt.value.toLowerCase()){e(!0);const b=await Gt(t);b.attributes&&typeof b.attributes=="object"?m=st(b.attributes):m=st(b)}m=m.filter(b=>b.key!=="node_key"),l(m),c(m)}catch(m){console.warn(m)}finally{e(!1)}};a.length===0&&f()},[t,d,l,a.length]),n.jsxs(n.Fragment,{children:[s?n.jsx(E,{align:"center",children:n.jsx(pe,{color:F.SECONDARY_BLUE,size:"30"})}):n.jsx(_n,{py:8,children:n.jsx(le,{container:!0,spacing:2,children:u.map((f,m)=>{const b=h(`attributes[${m}].type`),y=h(`attributes[${m}].required`),P=f.isNew||!1,C=["name"].includes(h(`attributes[${m}].key`));return n.jsxs(g.Fragment,{children:[n.jsx(le,{item:!0,xs:5,children:n.jsx(We,{autoComplete:"off",className:"text-input",dataTestId:`cy-item-name-${m}`,disabled:!P,id:`cy-item-name-${m}`,maxLength:50,name:`attributes.${m}.key`,placeholder:"Enter value",rules:{...Ve,pattern:{message:"Please avoid special characters, spaces and uppercase",value:kn}}})}),n.jsx(le,{item:!0,xs:4,children:n.jsx(Le,{dataTestId:`cy-item-select-${m}`,disabled:C,onSelect:v=>d(`attributes[${m}].type`,v==null?void 0:v.value),options:Tt,selectedValue:Tt.find(v=>v.value===b)})}),n.jsxs(le,{item:!0,xs:3,children:[n.jsx(vn,{checked:y,"data-testid":`cy-item-${m}`,disabled:C,name:`attributes.${m}.required`,onChange:v=>d(`attributes[${m}].required`,v.target.checked),size:"small"}),!C&&n.jsx(Po,{onClick:()=>{w(m),f.key!==void 0&&o&&o(f.key)},children:n.jsx(Co,{})})]})]},f.id)})})}),n.jsx(E,{align:"flex-start",py:12,children:n.jsx(Se,{"data-testid":"add-attribute-btn",onClick:()=>i({key:"",type:"string",required:!0,isNew:!0}),size:"medium",startIcon:n.jsx(To,{}),variant:"contained",children:"Add Attribute"})})]})},_n=L(E)`
  overflow-y: auto;
  width: calc(100% + 20px);
  max-height: calc(80vh - 300px);
`,In=({parent:t,onDelete:o})=>{const s=t;return n.jsxs(E,{children:[n.jsx(E,{direction:"row",mb:10,children:n.jsxs(le,{container:!0,spacing:2,children:[n.jsx(le,{item:!0,xs:5,children:n.jsx(tt,{style:{marginRight:180},children:"Attributes"})}),n.jsx(le,{item:!0,xs:4,children:n.jsx(tt,{style:{marginRight:130},children:"Type"})}),n.jsx(le,{item:!0,xs:3,children:n.jsx(tt,{children:"Required"})})]})}),s&&n.jsx($n,{onDelete:o,parentParam:s},s)]})},tt=L(q)`
  font-size: 15px;
  color: gray;
`,Nn={type:"",parent:""},zn=(t,o)=>t.length!==o.length?!0:t.some((s,e)=>{const a=o[e];return s.required!==a.required||s.type!==a.type||s.key!==a.key}),Rn=async(t,o=!1,s)=>{try{const{attributes:e,...a}=t,c={...Ao(e),...s.reduce((l,w)=>({...l,[w]:"delete"}),{})},u={...a,attributes:c};let i;if(o?i=await Fe.put(`/schema/${t.ref_id}`,JSON.stringify(u),{}):i=await Fe.post("/schema",JSON.stringify({...u,node_key:"name"}),{}),i.status!=="success")throw new Error("error");return i==null?void 0:i.ref_id}catch(e){let a=ge;if(e.status===400){const c=await e.json();a=c.errorCode||(c==null?void 0:c.status)||ge}else e instanceof Error&&(a=e.message);throw new Error(a)}},Bn=t=>t.charAt(0).toUpperCase()+t.slice(1),It=async(t,o)=>{try{const c=((await pt()).schemas||[]).filter(u=>!u.is_deleted&&u.type&&(!o||o(u))).map(u=>u.type==="thing"?{label:"No Parent",value:u.type}:{label:Bn(u.type),value:u.type});t(c)}catch(s){console.warn(s)}},Dn=({graphLoading:t,onSchemaCreate:o,selectedSchema:s,onDelete:e,setSelectedSchemaId:a,setGraphLoading:c,setIsCreateNew:u,onSchemaUpdate:i})=>{const{close:l,visible:w}=Ht("addType"),d=ft({mode:"onChange",defaultValues:s?{type:s.type,parent:s.parent}:Nn}),{watch:h,setValue:f,reset:m,getValues:b}=d,[y,P]=g.useState(!1),[C,v]=g.useState(!1),[M,k]=g.useState(!1),[j,x]=g.useState(null),[T,$]=g.useState(!1),[B,O]=g.useState(null),[D,J]=g.useState(""),[N,V]=g.useState(null),[U,ee]=g.useState([]),[Q,X]=g.useState([]),[H,de]=g.useState(!0);g.useEffect(()=>()=>{m()},[w,m]);const Ae=()=>{u(!1),a("")};g.useEffect(()=>{s||(k(!0),It(x).finally(()=>k(!1)))},[s]),g.useEffect(()=>{(async()=>{if(s){f("type",s==null?void 0:s.type),f("parent",s.parent);let z=[{required:!1,type:"string",key:""}];if(s.type!==Xt.value.toLowerCase()){const W=await Gt(s.type);z=W?st(W):z}z=z.filter(W=>W.key!=="node_key"),X(z),await It(O,W=>W.type!==s.type)}})()},[s,f]);const Z=h("parent");h("type");const Me=_=>Array.isArray(_)&&_.every(z=>typeof z=="object"&&"key"in z),xe=h("attributes"),ye=g.useMemo(()=>Me(xe)?xe:[],[xe]),Ge=()=>{l()},He=_=>{ee(z=>[...z,_])},Ke=async()=>{if(s!=null&&s.type){v(!0),c(!0);try{await Fe.delete(`/schema/${s.ref_id}`),e(s.type),l()}catch(_){let z=ge;if((_==null?void 0:_.status)===400){const W=await _.json();z=W.errorCode||(W==null?void 0:W.status)||ge}else _ instanceof Error&&(z=_.message);V(z)}finally{v(!1),c(!1),u(!1)}}},ke=d.handleSubmit(async _=>{if(!Z){$(!0);return}P(!0);try{if(s&&_.type!==(s==null?void 0:s.type)||s&&b().parent!==(s==null?void 0:s.parent)){const W=b().parent??(s==null?void 0:s.parent);c(!0),await Fe.put(`/schema/${s==null?void 0:s.ref_id}`,JSON.stringify({type:_.type,parent:W})),await i()}const z=await Rn({..._,...s?{ref_id:s==null?void 0:s.ref_id}:{}},!!s,U);o({type:_.type,parent:Z||"",ref_id:(s==null?void 0:s.ref_id)||z||"new"}),Ge()}catch(z){let W=ge;if((z==null?void 0:z.status)===400){const ae=await z.json();W=ae.errorCode||(ae==null?void 0:ae.status)||ge}else z instanceof Error&&(W=z.message);J(W)}finally{P(!1),c(!1),u(!1)}});g.useEffect(()=>{const _=d.watch(z=>{var je,ve,_e,Ie,Ee;const W=zn(ye,Q),ae=((je=z.type)==null?void 0:je.trim())!==((ve=s==null?void 0:s.type)==null?void 0:ve.trim())||((_e=z.parent)==null?void 0:_e.trim())!==((Ie=s==null?void 0:s.parent)==null?void 0:Ie.trim())||W,we=!!((Ee=z.type)!=null&&Ee.trim());de(s?y||!ae||!we||T:y||T||!we)});return()=>_.unsubscribe()},[d,ye,Q,s,y,T]);const Ze=()=>j==null?void 0:j.find(_=>_.value===Z),$e=()=>{const _=B==null?void 0:B.find(z=>z.value===Z);if(_)return _;if(Z)return{label:Z,value:Z}};return n.jsxs(E,{children:[n.jsx(E,{direction:"row",justify:"flex-end",children:n.jsx(Ln,{"data-testid":"close-sidebar-sub-view",onClick:Ae,children:n.jsx(Zt,{})})}),n.jsx(E,{children:n.jsx(Kt,{...d,children:n.jsxs("form",{id:"add-type-form",onSubmit:ke,children:[n.jsx(E,{children:s?n.jsxs(n.Fragment,{children:[n.jsxs(E,{mb:12,children:[n.jsx(E,{mb:12,children:n.jsx(q,{children:"Name"})}),n.jsx(E,{mb:12,children:n.jsx(We,{dataTestId:"cy-item-name",defaultValue:s==null?void 0:s.type,id:"cy-item-name",maxLength:250,name:"type",placeholder:"Enter type name",rules:{...Ve},value:Z})})]}),n.jsxs(E,{mb:12,children:[n.jsx(E,{mb:12,children:n.jsx(q,{children:"Parent"})}),n.jsx(Le,{isLoading:M||t,onSelect:_=>{f("parent",(_==null?void 0:_.value)||""),$(!1)},options:B||[],selectedValue:$e()}),D&&n.jsx(ot,{children:D})]})]}):n.jsxs(n.Fragment,{children:[n.jsxs(E,{mb:12,children:[n.jsx(E,{mb:12,children:n.jsx(q,{children:"Select Parent"})}),n.jsx(Le,{isLoading:M,onSelect:_=>{f("parent",(_==null?void 0:_.value)||""),$(!1)},options:j,selectedValue:Ze()}),T&&n.jsx(ot,{children:"A parent type must be selected"})]}),n.jsxs(E,{children:[n.jsx(E,{mb:12,children:n.jsx(q,{children:"Type name"})}),n.jsx(E,{mb:12,children:n.jsx(We,{id:"cy-item-name",maxLength:250,name:"type",placeholder:"Enter type name",rules:{...Ve},value:Z})})]})]})}),n.jsx(In,{onDelete:He,parent:s?s.type:Z}),n.jsxs(E,{direction:"row",justify:"space-between",mt:20,children:[s&&n.jsxs(E,{direction:"column",children:[n.jsxs(Fn,{color:"secondary",disabled:C,onClick:Ke,size:"large",style:{marginRight:20},variant:"contained",children:["Delete",C&&n.jsxs(Nt,{children:[n.jsx(pe,{color:F.lightGray,size:12})," "]})]}),N&&n.jsx(ot,{children:N})]}),n.jsxs(Vn,{color:"secondary",disabled:H,onClick:ke,size:"large",variant:"contained",children:["Confirm",y&&n.jsxs(Nt,{children:[n.jsx(pe,{color:F.lightGray,size:12})," "]})]})]})]})})})]})},Vn=L(Se)`
  width: 100% !important;
  margin: 0 auto !important;
`,Nt=L.span`
  margin-top: 2px;
`,Fn=L(Se)`
  && {
    color: ${F.primaryRed};
    background-color: rgba(237, 116, 116, 0.1);

    &:hover,
    &:active,
    &:focus {
      color: ${F.primaryRed};
      background-color: rgba(237, 116, 116, 0.2);
    }
  }
`,Ln=L(E)`
  font-size: 32px;
  color: ${F.white};
  cursor: pointer;
`,ot=L(E)`
  font-size: 13px;
  font-family: Barlow;
  color: #ff8f80;
  line-height: 0.2px;
  margin-top: 12px;
  padding-top: 20px;
`;var Wn=Object.defineProperty,Un=(t,o,s)=>o in t?Wn(t,o,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[o]=s,S=(t,o,s)=>(Un(t,typeof o!="symbol"?o+"":o,s),s);const De=new Ro,zt=new Bo,Yn=Math.cos(70*(Math.PI/180)),Rt=(t,o)=>(t%o+o)%o;let Gn=class extends Do{constructor(o,s){super(),S(this,"object"),S(this,"domElement"),S(this,"enabled",!0),S(this,"target",new I),S(this,"minDistance",0),S(this,"maxDistance",1/0),S(this,"minZoom",0),S(this,"maxZoom",1/0),S(this,"minPolarAngle",0),S(this,"maxPolarAngle",Math.PI),S(this,"minAzimuthAngle",-1/0),S(this,"maxAzimuthAngle",1/0),S(this,"enableDamping",!1),S(this,"dampingFactor",.05),S(this,"enableZoom",!0),S(this,"zoomSpeed",1),S(this,"enableRotate",!0),S(this,"rotateSpeed",1),S(this,"enablePan",!0),S(this,"panSpeed",1),S(this,"screenSpacePanning",!0),S(this,"keyPanSpeed",7),S(this,"zoomToCursor",!1),S(this,"autoRotate",!1),S(this,"autoRotateSpeed",2),S(this,"reverseOrbit",!1),S(this,"reverseHorizontalOrbit",!1),S(this,"reverseVerticalOrbit",!1),S(this,"keys",{LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"}),S(this,"mouseButtons",{LEFT:he.ROTATE,MIDDLE:he.DOLLY,RIGHT:he.PAN}),S(this,"touches",{ONE:me.ROTATE,TWO:me.DOLLY_PAN}),S(this,"target0"),S(this,"position0"),S(this,"zoom0"),S(this,"_domElementKeyEvents",null),S(this,"getPolarAngle"),S(this,"getAzimuthalAngle"),S(this,"setPolarAngle"),S(this,"setAzimuthalAngle"),S(this,"getDistance"),S(this,"listenToKeyEvents"),S(this,"stopListenToKeyEvents"),S(this,"saveState"),S(this,"reset"),S(this,"update"),S(this,"connect"),S(this,"dispose"),this.object=o,this.domElement=s,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=()=>d.phi,this.getAzimuthalAngle=()=>d.theta,this.setPolarAngle=r=>{let p=Rt(r,2*Math.PI),A=d.phi;A<0&&(A+=2*Math.PI),p<0&&(p+=2*Math.PI);let R=Math.abs(p-A);2*Math.PI-R<R&&(p<A?p+=2*Math.PI:A+=2*Math.PI),h.phi=p-A,e.update()},this.setAzimuthalAngle=r=>{let p=Rt(r,2*Math.PI),A=d.theta;A<0&&(A+=2*Math.PI),p<0&&(p+=2*Math.PI);let R=Math.abs(p-A);2*Math.PI-R<R&&(p<A?p+=2*Math.PI:A+=2*Math.PI),h.theta=p-A,e.update()},this.getDistance=()=>e.object.position.distanceTo(e.target),this.listenToKeyEvents=r=>{r.addEventListener("keydown",Qe),this._domElementKeyEvents=r},this.stopListenToKeyEvents=()=>{this._domElementKeyEvents.removeEventListener("keydown",Qe),this._domElementKeyEvents=null},this.saveState=()=>{e.target0.copy(e.target),e.position0.copy(e.object.position),e.zoom0=e.object.zoom},this.reset=()=>{e.target.copy(e.target0),e.object.position.copy(e.position0),e.object.zoom=e.zoom0,e.object.updateProjectionMatrix(),e.dispatchEvent(a),e.update(),l=i.NONE},this.update=(()=>{const r=new I,p=new I(0,1,0),A=new St().setFromUnitVectors(o.up,p),R=A.clone().invert(),Y=new I,se=new St,ce=2*Math.PI;return function(){const yt=e.object.position;A.setFromUnitVectors(o.up,p),R.copy(A).invert(),r.copy(yt).sub(e.target),r.applyQuaternion(A),d.setFromVector3(r),e.autoRotate&&l===i.NONE&&V(J()),e.enableDamping?(d.theta+=h.theta*e.dampingFactor,d.phi+=h.phi*e.dampingFactor):(d.theta+=h.theta,d.phi+=h.phi);let re=e.minAzimuthAngle,ie=e.maxAzimuthAngle;isFinite(re)&&isFinite(ie)&&(re<-Math.PI?re+=ce:re>Math.PI&&(re-=ce),ie<-Math.PI?ie+=ce:ie>Math.PI&&(ie-=ce),re<=ie?d.theta=Math.max(re,Math.min(ie,d.theta)):d.theta=d.theta>(re+ie)/2?Math.max(re,d.theta):Math.min(ie,d.theta)),d.phi=Math.max(e.minPolarAngle,Math.min(e.maxPolarAngle,d.phi)),d.makeSafe(),e.enableDamping===!0?e.target.addScaledVector(m,e.dampingFactor):e.target.add(m),e.zoomToCursor&&B||e.object.isOrthographicCamera?d.radius=Z(d.radius):d.radius=Z(d.radius*f),r.setFromSpherical(d),r.applyQuaternion(R),yt.copy(e.target).add(r),e.object.matrixAutoUpdate||e.object.updateMatrix(),e.object.lookAt(e.target),e.enableDamping===!0?(h.theta*=1-e.dampingFactor,h.phi*=1-e.dampingFactor,m.multiplyScalar(1-e.dampingFactor)):(h.set(0,0,0),m.set(0,0,0));let Ne=!1;if(e.zoomToCursor&&B){let Pe=null;if(e.object instanceof Re&&e.object.isPerspectiveCamera){const Ce=r.length();Pe=Z(Ce*f);const ze=Ce-Pe;e.object.position.addScaledVector(T,ze),e.object.updateMatrixWorld()}else if(e.object.isOrthographicCamera){const Ce=new I($.x,$.y,0);Ce.unproject(e.object),e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom/f)),e.object.updateProjectionMatrix(),Ne=!0;const ze=new I($.x,$.y,0);ze.unproject(e.object),e.object.position.sub(ze).add(Ce),e.object.updateMatrixWorld(),Pe=r.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),e.zoomToCursor=!1;Pe!==null&&(e.screenSpacePanning?e.target.set(0,0,-1).transformDirection(e.object.matrix).multiplyScalar(Pe).add(e.object.position):(De.origin.copy(e.object.position),De.direction.set(0,0,-1).transformDirection(e.object.matrix),Math.abs(e.object.up.dot(De.direction))<Yn?o.lookAt(e.target):(zt.setFromNormalAndCoplanarPoint(e.object.up,e.target),De.intersectPlane(zt,e.target))))}else e.object instanceof Be&&e.object.isOrthographicCamera&&(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom/f)),e.object.updateProjectionMatrix(),Ne=!0);return f=1,B=!1,Ne||Y.distanceToSquared(e.object.position)>w||8*(1-se.dot(e.object.quaternion))>w?(e.dispatchEvent(a),Y.copy(e.object.position),se.copy(e.object.quaternion),Ne=!1,!0):!1}})(),this.connect=r=>{r===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),e.domElement=r,e.domElement.style.touchAction="none",e.domElement.addEventListener("contextmenu",gt),e.domElement.addEventListener("pointerdown",Ee),e.domElement.addEventListener("pointercancel",ht),e.domElement.addEventListener("wheel",mt)},this.dispose=()=>{var r,p,A,R,Y,se;(r=e.domElement)==null||r.removeEventListener("contextmenu",gt),(p=e.domElement)==null||p.removeEventListener("pointerdown",Ee),(A=e.domElement)==null||A.removeEventListener("pointercancel",ht),(R=e.domElement)==null||R.removeEventListener("wheel",mt),(Y=e.domElement)==null||Y.ownerDocument.removeEventListener("pointermove",Xe),(se=e.domElement)==null||se.ownerDocument.removeEventListener("pointerup",qe),e._domElementKeyEvents!==null&&e._domElementKeyEvents.removeEventListener("keydown",Qe)};const e=this,a={type:"change"},c={type:"start"},u={type:"end"},i={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let l=i.NONE;const w=1e-6,d=new At,h=new At;let f=1;const m=new I,b=new te,y=new te,P=new te,C=new te,v=new te,M=new te,k=new te,j=new te,x=new te,T=new I,$=new te;let B=!1;const O=[],D={};function J(){return 2*Math.PI/60/60*e.autoRotateSpeed}function N(){return Math.pow(.95,e.zoomSpeed)}function V(r){e.reverseOrbit||e.reverseHorizontalOrbit?h.theta+=r:h.theta-=r}function U(r){e.reverseOrbit||e.reverseVerticalOrbit?h.phi+=r:h.phi-=r}const ee=(()=>{const r=new I;return function(A,R){r.setFromMatrixColumn(R,0),r.multiplyScalar(-A),m.add(r)}})(),Q=(()=>{const r=new I;return function(A,R){e.screenSpacePanning===!0?r.setFromMatrixColumn(R,1):(r.setFromMatrixColumn(R,0),r.crossVectors(e.object.up,r)),r.multiplyScalar(A),m.add(r)}})(),X=(()=>{const r=new I;return function(A,R){const Y=e.domElement;if(Y&&e.object instanceof Re&&e.object.isPerspectiveCamera){const se=e.object.position;r.copy(se).sub(e.target);let ce=r.length();ce*=Math.tan(e.object.fov/2*Math.PI/180),ee(2*A*ce/Y.clientHeight,e.object.matrix),Q(2*R*ce/Y.clientHeight,e.object.matrix)}else Y&&e.object instanceof Be&&e.object.isOrthographicCamera?(ee(A*(e.object.right-e.object.left)/e.object.zoom/Y.clientWidth,e.object.matrix),Q(R*(e.object.top-e.object.bottom)/e.object.zoom/Y.clientHeight,e.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),e.enablePan=!1)}})();function H(r){e.object instanceof Re&&e.object.isPerspectiveCamera||e.object instanceof Be&&e.object.isOrthographicCamera?f/=r:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function de(r){e.object instanceof Re&&e.object.isPerspectiveCamera||e.object instanceof Be&&e.object.isOrthographicCamera?f*=r:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function Ae(r){if(!e.zoomToCursor||!e.domElement)return;B=!0;const p=e.domElement.getBoundingClientRect(),A=r.clientX-p.left,R=r.clientY-p.top,Y=p.width,se=p.height;$.x=A/Y*2-1,$.y=-(R/se)*2+1,T.set($.x,$.y,1).unproject(e.object).sub(e.object.position).normalize()}function Z(r){return Math.max(e.minDistance,Math.min(e.maxDistance,r))}function Me(r){b.set(r.clientX,r.clientY)}function xe(r){Ae(r),k.set(r.clientX,r.clientY)}function ye(r){C.set(r.clientX,r.clientY)}function Ge(r){y.set(r.clientX,r.clientY),P.subVectors(y,b).multiplyScalar(e.rotateSpeed);const p=e.domElement;p&&(V(2*Math.PI*P.x/p.clientHeight),U(2*Math.PI*P.y/p.clientHeight)),b.copy(y),e.update()}function He(r){j.set(r.clientX,r.clientY),x.subVectors(j,k),x.y>0?H(N()):x.y<0&&de(N()),k.copy(j),e.update()}function Ke(r){v.set(r.clientX,r.clientY),M.subVectors(v,C).multiplyScalar(e.panSpeed),X(M.x,M.y),C.copy(v),e.update()}function ke(r){Ae(r),r.deltaY<0?de(N()):r.deltaY>0&&H(N()),e.update()}function Ze(r){let p=!1;switch(r.code){case e.keys.UP:X(0,e.keyPanSpeed),p=!0;break;case e.keys.BOTTOM:X(0,-e.keyPanSpeed),p=!0;break;case e.keys.LEFT:X(e.keyPanSpeed,0),p=!0;break;case e.keys.RIGHT:X(-e.keyPanSpeed,0),p=!0;break}p&&(r.preventDefault(),e.update())}function $e(){if(O.length==1)b.set(O[0].pageX,O[0].pageY);else{const r=.5*(O[0].pageX+O[1].pageX),p=.5*(O[0].pageY+O[1].pageY);b.set(r,p)}}function _(){if(O.length==1)C.set(O[0].pageX,O[0].pageY);else{const r=.5*(O[0].pageX+O[1].pageX),p=.5*(O[0].pageY+O[1].pageY);C.set(r,p)}}function z(){const r=O[0].pageX-O[1].pageX,p=O[0].pageY-O[1].pageY,A=Math.sqrt(r*r+p*p);k.set(0,A)}function W(){e.enableZoom&&z(),e.enablePan&&_()}function ae(){e.enableZoom&&z(),e.enableRotate&&$e()}function we(r){if(O.length==1)y.set(r.pageX,r.pageY);else{const A=Je(r),R=.5*(r.pageX+A.x),Y=.5*(r.pageY+A.y);y.set(R,Y)}P.subVectors(y,b).multiplyScalar(e.rotateSpeed);const p=e.domElement;p&&(V(2*Math.PI*P.x/p.clientHeight),U(2*Math.PI*P.y/p.clientHeight)),b.copy(y)}function je(r){if(O.length==1)v.set(r.pageX,r.pageY);else{const p=Je(r),A=.5*(r.pageX+p.x),R=.5*(r.pageY+p.y);v.set(A,R)}M.subVectors(v,C).multiplyScalar(e.panSpeed),X(M.x,M.y),C.copy(v)}function ve(r){const p=Je(r),A=r.pageX-p.x,R=r.pageY-p.y,Y=Math.sqrt(A*A+R*R);j.set(0,Y),x.set(0,Math.pow(j.y/k.y,e.zoomSpeed)),H(x.y),k.copy(j)}function _e(r){e.enableZoom&&ve(r),e.enablePan&&je(r)}function Ie(r){e.enableZoom&&ve(r),e.enableRotate&&we(r)}function Ee(r){var p,A;e.enabled!==!1&&(O.length===0&&((p=e.domElement)==null||p.ownerDocument.addEventListener("pointermove",Xe),(A=e.domElement)==null||A.ownerDocument.addEventListener("pointerup",qe)),ao(r),r.pointerType==="touch"?ro(r):no(r))}function Xe(r){e.enabled!==!1&&(r.pointerType==="touch"?io(r):so(r))}function qe(r){var p,A,R;bt(r),O.length===0&&((p=e.domElement)==null||p.releasePointerCapture(r.pointerId),(A=e.domElement)==null||A.ownerDocument.removeEventListener("pointermove",Xe),(R=e.domElement)==null||R.ownerDocument.removeEventListener("pointerup",qe)),e.dispatchEvent(u),l=i.NONE}function ht(r){bt(r)}function no(r){let p;switch(r.button){case 0:p=e.mouseButtons.LEFT;break;case 1:p=e.mouseButtons.MIDDLE;break;case 2:p=e.mouseButtons.RIGHT;break;default:p=-1}switch(p){case he.DOLLY:if(e.enableZoom===!1)return;xe(r),l=i.DOLLY;break;case he.ROTATE:if(r.ctrlKey||r.metaKey||r.shiftKey){if(e.enablePan===!1)return;ye(r),l=i.PAN}else{if(e.enableRotate===!1)return;Me(r),l=i.ROTATE}break;case he.PAN:if(r.ctrlKey||r.metaKey||r.shiftKey){if(e.enableRotate===!1)return;Me(r),l=i.ROTATE}else{if(e.enablePan===!1)return;ye(r),l=i.PAN}break;default:l=i.NONE}l!==i.NONE&&e.dispatchEvent(c)}function so(r){if(e.enabled!==!1)switch(l){case i.ROTATE:if(e.enableRotate===!1)return;Ge(r);break;case i.DOLLY:if(e.enableZoom===!1)return;He(r);break;case i.PAN:if(e.enablePan===!1)return;Ke(r);break}}function mt(r){e.enabled===!1||e.enableZoom===!1||l!==i.NONE&&l!==i.ROTATE||(r.preventDefault(),e.dispatchEvent(c),ke(r),e.dispatchEvent(u))}function Qe(r){e.enabled===!1||e.enablePan===!1||Ze(r)}function ro(r){switch(xt(r),O.length){case 1:switch(e.touches.ONE){case me.ROTATE:if(e.enableRotate===!1)return;$e(),l=i.TOUCH_ROTATE;break;case me.PAN:if(e.enablePan===!1)return;_(),l=i.TOUCH_PAN;break;default:l=i.NONE}break;case 2:switch(e.touches.TWO){case me.DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;W(),l=i.TOUCH_DOLLY_PAN;break;case me.DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;ae(),l=i.TOUCH_DOLLY_ROTATE;break;default:l=i.NONE}break;default:l=i.NONE}l!==i.NONE&&e.dispatchEvent(c)}function io(r){switch(xt(r),l){case i.TOUCH_ROTATE:if(e.enableRotate===!1)return;we(r),e.update();break;case i.TOUCH_PAN:if(e.enablePan===!1)return;je(r),e.update();break;case i.TOUCH_DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;_e(r),e.update();break;case i.TOUCH_DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;Ie(r),e.update();break;default:l=i.NONE}}function gt(r){e.enabled!==!1&&r.preventDefault()}function ao(r){O.push(r)}function bt(r){delete D[r.pointerId];for(let p=0;p<O.length;p++)if(O[p].pointerId==r.pointerId){O.splice(p,1);return}}function xt(r){let p=D[r.pointerId];p===void 0&&(p=new te,D[r.pointerId]=p),p.set(r.pageX,r.pageY)}function Je(r){const p=r.pointerId===O[0].pointerId?O[1]:O[0];return D[p.pointerId]}s!==void 0&&this.connect(s),this.update()}};const Hn=new I,Bt=g.forwardRef(function({start:o=[0,0,0],end:s=[0,0,0],mid:e,segments:a=20,...c},u){const i=g.useRef(null),[l]=g.useState(()=>new Vo(void 0,void 0,void 0)),w=g.useCallback((h,f,m,b=20)=>(h instanceof I?l.v0.copy(h):l.v0.set(...h),f instanceof I?l.v2.copy(f):l.v2.set(...f),m instanceof I?l.v1.copy(m):l.v1.copy(l.v0.clone().add(l.v2.clone().sub(l.v0)).add(Hn.set(0,l.v0.y-l.v2.y,0))),l.getPoints(b)),[]);g.useLayoutEffect(()=>{i.current.setPoints=(h,f,m)=>{const b=w(h,f,m);i.current.geometry&&i.current.geometry.setPositions(b.map(y=>y.toArray()).flat())}},[]);const d=g.useMemo(()=>w(o,s,e,a),[o,s,e,a]);return g.createElement(ko,G({ref:$o([i,u]),points:d},c))}),Kn=g.forwardRef(({makeDefault:t,camera:o,regress:s,domElement:e,enableDamping:a=!0,onChange:c,onStart:u,onEnd:i,...l},w)=>{const d=ne(j=>j.invalidate),h=ne(j=>j.camera),f=ne(j=>j.gl),m=ne(j=>j.events),b=ne(j=>j.setEvents),y=ne(j=>j.set),P=ne(j=>j.get),C=ne(j=>j.performance),v=o||h,M=e||m.connected||f.domElement,k=g.useMemo(()=>new Gn(v),[v]);return Ye(()=>{k.enabled&&k.update()},-1),g.useEffect(()=>(k.connect(M),()=>void k.dispose()),[M,s,k,d]),g.useEffect(()=>{const j=$=>{d(),s&&C.regress(),c&&c($)},x=$=>{u&&u($)},T=$=>{i&&i($)};return k.addEventListener("change",j),k.addEventListener("start",x),k.addEventListener("end",T),()=>{k.removeEventListener("start",x),k.removeEventListener("end",T),k.removeEventListener("change",j)}},[c,u,i,k,d,b]),g.useEffect(()=>{if(t){const j=P().controls;return y({controls:k}),()=>y({controls:j})}},[t,k]),g.createElement("primitive",G({ref:w,object:k,enableDamping:a},l))});function Zn(t){const o=t+"Geometry";return g.forwardRef(({args:s,children:e,...a},c)=>g.createElement("mesh",G({ref:c},a),g.createElement(o,{attach:"geometry",args:s}),e))}const Xn=Zn("circle"),oe=10,qn=2,Qn=2,Dt=10,Jn=10,Vt=(t,o,s)=>{const c=new I().subVectors(o,t).normalize().multiplyScalar(s);return new I().addVectors(t,c)},es=(t,o,s,e)=>{const a=new I().lerpVectors(t,o,.5),c=new I().subVectors(o,t).normalize(),u=new I(-c.y,c.x,c.z).normalize(),i=(s-e/2)*Jn;return new I().addVectors(a,u.multiplyScalar(i))},to=({links:t,nodes:o,onEdgeClick:s})=>{const e=g.useRef(null),{camera:a}=ne(),c=new I,u=new I,i=new I,l=new I,w=new I,d=new I,h=new I,f=new I;Ye(()=>{e.current&&o&&e.current.children.forEach((b,y)=>{var B,O,D,J;const P=t[y];if(!P)return;const C=o.find(N=>N.ref_id===P.target),v=o.find(N=>N.ref_id===P.source);c.set((v==null?void 0:v.x)||0,(v==null?void 0:v.y)||0,(v==null?void 0:v.z)||0),u.set((C==null?void 0:C.x)||0,(C==null?void 0:C.y)||0,(C==null?void 0:C.z)||0);const M=b.children[0],k=b.children[1],j=b.children[2],x=b.children[3],T=t.filter(N=>N.source===P.source&&N.target===P.target||N.source===P.target&&N.target===P.source).length,$=t.filter((N,V)=>V<y&&(N.source===P.source&&N.target===P.target||N.source===P.target&&N.target===P.source)).length;if((v==null?void 0:v.ref_id)===(C==null?void 0:C.ref_id)){const[N,V,U]=Mo(c);(B=M.setPoints)==null||B.call(M,c,U,N),(O=k.setPoints)==null||O.call(k,U,u,N),j.position.set(U.x,U.y,V.z),j.lookAt(N),j.rotateX(-Math.PI/2),x.position.set(U.x,U.y,V.z),x.lookAt(a.position)}else{f.copy(Vt(c,u,oe)),h.copy(Vt(u,c,oe+.5)),i.lerpVectors(f,h,.5),T>1?i.copy(es(f,h,$,T)):i.lerpVectors(f,h,.5);const N=30;l.subVectors(h,f).normalize().multiplyScalar(N/2),w.subVectors(i,l),d.addVectors(i,l);const V=new I().addVectors(f,w).multiplyScalar(.5),U=new I().addVectors(d,h).multiplyScalar(.5);(D=M.setPoints)==null||D.call(M,f,w,V),(J=k.setPoints)==null||J.call(k,d,h,U),j.position.set(h.x,h.y,h.z),j.lookAt(f),j.rotateX(-Math.PI/2),x.position.set(i.x,i.y,i.z),x.lookAt(a.position);let ee=Math.atan2(h.y-f.y,h.x-f.x);(ee>Math.PI/2||ee<-Math.PI/2)&&(ee+=Math.PI),x.rotation.set(0,0,ee);const Q=f.distanceTo(h),X=Q<N?2:4;Q<N?x.text=rt(P.edge_type,Dt):x.text=P.edge_type,x.fontSize=X}})});const m=(b,y,P,C)=>{if(b==="CHILD_OF"||y==="string"||P==="string")return;const v=o==null?void 0:o.find(x=>x.ref_id===y),M=o==null?void 0:o.find(x=>x.ref_id===P),k=(v==null?void 0:v.type)||"",j=(M==null?void 0:M.type)||"";s(C,b,k,j)};return n.jsx("group",{ref:e,children:t.map(b=>n.jsxs("group",{children:[n.jsx(Bt,{color:"white",end:[0,0,0],lineWidth:1,start:[0,0,0]}),n.jsx(Bt,{color:"white",end:[0,0,0],lineWidth:1,start:[0,0,0]}),n.jsxs("mesh",{position:new I(0,0,0),children:[n.jsx("coneGeometry",{args:[qn,Qn,32]}),n.jsx("meshBasicMaterial",{color:"white"})]}),n.jsx(Qt,{anchorX:"center",anchorY:"middle",color:"white",...Jt,lineHeight:1,maxWidth:20,onClick:()=>m(b.edge_type,b.source,b.target,b.ref_id),rotation:[0,0,0],textAlign:"center",children:rt(b.edge_type,Dt)})]},b.ref_id))})};to.displayName="Lines";const ts=["#ff13c9","#5af0ff","#3233ff","#c2f0c2","#ff6666","#99ccff","#ffb3b3"],os=L.div`
  color: white;
  background: rgba(0, 0, 0, 1);
  padding: 2px 5px;
  border-radius: 4px;
  word-wrap: break-word;
  text-align: center;
  white-space: nowrap;
  visibility: visible;
  font-size: 12px;
  font-style: normal;
  font-weight: 400;
`,ns=L(_o)`
  position: absolute;
`;new Fo(2,2,2);const oo=g.memo(({node:t,setSelectedNode:o,onSimulationUpdate:s,isSelected:e})=>{var y;const a=g.useRef(null),[c,u]=g.useState(!1);console.log(e);const{size:i,camera:l}=ne(),w=Oo(P=>{if(t.type==="Thing")return;const{xy:[C,v],down:M,dragging:k,first:j,elapsedTime:x}=P;if(!(!k||j||x<100)&&M&&a.current){s();const T=(C-i.left)/window.innerWidth*i.width,$=(v-i.top)/window.innerHeight*i.height,D=new I(T/i.width*2-1,-$/i.height*2+1,0).unproject(l).multiply(new I(1,1,0)).clone();t.fx=D.x,t.fy=D.y}});Ye(()=>{a.current&&a.current.position.set(t.x||0,t.y||0,0)});const d=ts[(y=t==null?void 0:t.children)==null?void 0:y.length]||"red",h=P=>{P.stopPropagation(),t.type!=="Thing"&&o()},f=rt(t.type||"",oe),m=()=>{u(!0)},b=()=>{u(!1)};return n.jsxs("mesh",{ref:a,onClick:h,...w(),onPointerOut:b,onPointerOver:m,position:new I(t.x,t.y,0),children:[n.jsx(Xn,{args:[oe,30,20],children:n.jsx("meshStandardMaterial",{attach:"material",color:d})}),n.jsx(Qt,{...Jt,clipRect:[-oe,-oe,oe,oe],color:"#000",fontSize:2,maxWidth:oe*2,name:t.type,textAlign:"left",children:f}),c&&n.jsx(ns,{position:[0,5,0],zIndexRange:[100,0],children:n.jsx(os,{children:t.type})})]})});oo.displayName="Node";const ss=({simulation:t,setSelectedSchemaId:o,selectedId:s,setIsAddEdgeNode:e})=>{const[a]=qt(u=>[u.schemas]),c=()=>{t&&(t.alpha(.05),t.restart())};return n.jsx(n.Fragment,{children:a.map((u,i)=>{const l=t.nodes()[i];return l?n.jsx(oo,{isSelected:l.ref_id===s,node:l,onSimulationUpdate:c,setSelectedNode:()=>{e(!1),o(l.ref_id)}},l.ref_id):null})})},rs=({schemasWithPositions:t,filteredLinks:o,setSelectedSchemaId:s,selectedSchemaId:e,setIsAddEdgeNode:a,onEdgeClick:c})=>{const[u,i]=g.useState(null),l=Ot(t),w=Ot(o);return g.useEffect(()=>{if(!t.length||!o.length)return;const d=structuredClone(t),h=structuredClone(o);if(u){l&&l.length!==t.length&&w&&w.length!==o.length&&(u.nodes(d).force("link",jt(h).id(m=>m.ref_id).distance(100)).force("charge",vt()).force("center",Et()).force("collide",Pt(oe+5)).alpha(.5).restart(),i({...u}));return}const f=mo(d).force("link",jt(h).id(m=>m.ref_id).distance(120)).force("charge",vt().strength(-100)).force("center",Et()).force("collide",Pt(oe+5));i(f)},[t,u,o,l,w]),Ye(()=>{}),u?n.jsxs(n.Fragment,{children:[n.jsx(to,{links:o,nodes:u.nodes(),onEdgeClick:c}),n.jsx(ss,{selectedId:e,setIsAddEdgeNode:a,setSelectedSchemaId:s,simulation:u})]}):null},nt=new Lo(0),is=({selectedSchemaId:t,links:o,schemasWithPositions:s,setSelectedSchemaId:e,setIsAddEdgeNode:a,onEdgeClick:c})=>n.jsxs(Io,{camera:{zoom:1,position:[0,0,200]},id:"schema-canvas",linear:!0,orthographic:!0,children:[n.jsx("color",{args:[nt.r,nt.g,nt.b],attach:"background"}),go&&n.jsx(No,{position:"right-bottom"}),n.jsx(as,{}),n.jsx(zo,{}),n.jsx(rs,{filteredLinks:o,onEdgeClick:c,schemasWithPositions:s,selectedSchemaId:t,setIsAddEdgeNode:a,setSelectedSchemaId:e})]}),as=()=>{g.useEffect(()=>{const s=a=>{["Meta","Alt"].includes(a.key)&&(document.body.style.cursor="grab")},e=a=>{["Meta","Alt"].includes(a.key)&&(document.body.style.cursor="default")};return window.addEventListener("keydown",s,!1),window.addEventListener("keyup",e,!1),()=>{window.removeEventListener("keydown",s,!1),window.removeEventListener("keyup",e,!1)}},[]);const t=()=>{document.body.style.cursor="grabbing"},o=()=>{document.body.style.cursor="default"};return n.jsx(Kn,{dampingFactor:1,enableDamping:!0,enablePan:!0,enableRotate:!1,enableZoom:!0,maxZoom:20,minZoom:1,onEnd:o,onStart:t,zoomSpeed:1.5,zoomToCursor:!0})},cs=({onCreateNew:t,onAddEdgeNode:o})=>n.jsxs(ls,{children:[n.jsx(ds,{children:"BLUEPRINT"}),n.jsxs(Ft,{"data-testid":"add-schema-type",onClick:t,children:[n.jsx(Lt,{children:n.jsx(Mt,{})}),n.jsx(q,{children:"Add Type"})]}),n.jsxs(Ft,{"data-testid":"add-edge",onClick:o,children:[n.jsx(Lt,{children:n.jsx(Mt,{})}),n.jsx(q,{children:"Add Edge"})]})]}),ls=L(E).attrs({align:"flex-start",direction:"column",justify:"flex-start"})`
  flex: 1 1 auto;
  z-index: 31;
  transition: opacity 1s;
  background: ${F.BG2};
  max-height: 100vh;
  border-top-left-radius: 9px;
  border-bottom-left-radius: 9px;

  @media (max-width: 1440px) {
    max-height: 95.2vh;
  }

  @media (max-width: 1024px) {
    max-height: 74.8vh;
  }

  @media (max-width: 924px) {
    max-height: 73.1vh;
  }
`,Ft=L(E).attrs({align:"center",justify:"center",p:0})`
  position: relative;
  width: 64px;
  height: 58px;
  padding: 0;
  flex-direction: row;
  color: ${F.GRAY6};
  cursor: pointer;
  transition: ${({theme:t})=>t.transitions.create(["opacity","box-shadow","background-color"])};

  &:before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 4px; /* Initial width */
    height: 32px; /* Initial height on hover */
    background-color: transparent;
    transition: height 0.3s, width 0.3s, background-color 0.3s;
  }

  ${q} {
    display: none;
    opacity: 0;
    width: 0;
    padding: 4px 10px;
    border-radius: 4px;
    background: #000;
    box-shadow: 0px 4px 8px 0px rgba(0, 0, 0, 0.25);
    position: absolute;
    left: 90%;
    z-index: 99;
    white-space: nowrap;
    visibility: visible;
    font-size: 11px;
    font-style: normal;
    font-weight: 400;
    transition: ${({theme:t})=>t.transitions.create(["opacity","visually"])};
  }

  &:hover {
    color: ${F.white};

    &:before {
      width: 3px;
      height: 32px;
      background-color: ${F.primaryBlue};
    }

    ${q} {
      display: block;
      width: min-content;
      opacity: 1;
      visibility: visible;
    }
  }

  &:active {
    color: ${F.white};
    background: ${F.black};
    &:before {
      width: 3px;
      height: 100%;
      background-color: ${F.primaryBlue};
    }
  }

  &.root {
    border-radius: 50%;
    padding: 0;
    align-items: center;
    justify-content: center;
    border: none;
  }
`,ds=L(E)`
  background: blue;
  align-items: center;
  justify-content: center;
  background: ${F.primaryBlue};
  width: 64px;
  height: 64px;
  cursor: pointer;
  font-size: 10px;
  font-weight: 600;
  color: ${F.white};
`,Lt=L(E)`
  justify-content: center;
  align-items: center;
  font-size: 24px;
`,us=()=>{const[t,o]=g.useState(""),[s,e]=g.useState(!1),[a,c]=g.useState(!1),[u,i]=g.useState(!1),[l,w]=g.useState({refId:"",edgeType:"",source:"",target:""}),[d,h]=g.useState(!1),[f,m,b,y]=qt(x=>[x.schemas,x.links,x.setSchemas,x.setSchemaLinks]);g.useEffect(()=>{(async()=>{c(!0);try{const T=await Ct(),$=T.schemas.filter(B=>B.ref_id&&!B.is_deleted);b($.length>0?$:T.schemas),y(T.edges.length>0?T.edges:[]),c(!1)}catch(T){console.error("Error fetching data:",T),c(!1)}})()},[b,y]);const P=x=>{if(f.some($=>$.ref_id===x.ref_id))b(f.map($=>$.ref_id===x.ref_id?{...x,children:[]}:$));else{b([...f,{...x,children:[]}]);const $=f.find(B=>x.parent===B.type);y([...m,{ref_id:`new-link-${m.length}`,edge_type:"CHILD_OF",source:x.ref_id||"new",target:($==null?void 0:$.ref_id)||"new"}])}},C=async()=>{const x=await Ct();b(x.schemas.filter(T=>T.ref_id&&!T.is_deleted&&T.ref_id)),y(x.edges)},v=x=>{b(f.filter(T=>T.type!==x))},M=f.map(x=>({...x,children:f.filter(T=>T.parent===x.type).map(T=>T.ref_id||"")})),k=m.filter(x=>M.some(T=>T.ref_id===x.source)&&M.some(T=>T.ref_id===x.target)),j=f.find(x=>x.ref_id===t)||null;return a?n.jsx(E,{align:"center",basis:"100%",grow:1,justify:"center",shrink:1,children:n.jsx(pe,{color:F.white})}):n.jsx(n.Fragment,{children:n.jsxs(E,{align:"stretch",direction:"row",grow:1,children:[n.jsx(E,{ml:-20,my:-20,children:n.jsx(cs,{onAddEdgeNode:()=>{i(!0),e(!1),o(""),w({refId:"",edgeType:"",source:"",target:""})},onCreateNew:()=>{i(!1),e(!0),o("")}})}),n.jsx(E,{children:j||s?n.jsx(Wt,{children:n.jsx(Ut,{children:n.jsx(Dn,{graphLoading:d,onDelete:v,onSchemaCreate:P,onSchemaUpdate:C,selectedSchema:j,setGraphLoading:h,setIsCreateNew:e,setSelectedSchemaId:o})})}):null}),n.jsx(E,{children:u?n.jsx(Wt,{children:n.jsx(Ut,{children:n.jsx(An,{edgeData:l,setGraphLoading:h,setIsAddEdgeNode:i})})}):null}),n.jsx(ps,{direction:"row",grow:1,children:n.jsx(fs,{children:d?n.jsx(E,{align:"center",basis:"100%",grow:1,justify:"center",shrink:1,children:n.jsx(pe,{color:F.white})}):n.jsx(is,{links:k,onEdgeClick:(x,T,$,B)=>{w({refId:x,edgeType:T,source:$,target:B}),i(!0),e(!1),o("")},schemasWithPositions:M,selectedSchemaId:t,setIsAddEdgeNode:i,setSelectedSchemaId:o})})})]})})},ps=L(E)`
  flex: 1 1 auto;
  justify-content: center;
  position: relative;
  overflow: hidden;
  max-height: calc(100vh - 20px);

  @media (max-width: 1440px) {
    max-height: calc(95vh - 20px);
  }

  @media (max-width: 1024px) {
    max-height: calc(70vh - 20px);
  }

  @media (max-width: 924px) {
    max-height: calc(70vh - 20px);
  }
`,Wt=L(E)`
  width: 100%;
  max-width: 400px;
  background: ${F.BG1};
  border-top-right-radius: 16px;
  border-bottom-right-radius: 16px;
  flex-grow: 1;
  flex-shrink: 1;
  min-width: 300px;
  overflow: hidden;
  max-height: calc(100vh - 20px);

  @media (max-width: 1440px) {
    max-height: calc(95vh - 20px);
  }

  @media (max-width: 1024px) {
    max-height: calc(70vh - 20px);
  }

  @media (max-width: 924px) {
    max-height: calc(70vh - 20px);
  }
`,Ut=L.div`
  height: 100%;
  overflow-y: auto;
  padding: 16px;
`,fs=L(E)`
  flex: 1 1 100%;
`,hs=()=>{const{close:t}=Ht("blueprintGraph"),o=()=>{t()};return n.jsx(So,{background:"black",id:"blueprintGraph",kind:"full",onClose:o,preventOutsideClose:!0,children:n.jsx(us,{})})},Es=g.memo(hs);export{Es as BlueprintModal};
