import{r as a,B as ue,j as l,s as z,c as C,F as Ne,X as ke,p as st,u as nt,a4 as ot,a5 as rt,a6 as it,a7 as at,g as ct}from"./index-b00f070c.js";import{u as pe,a as fe,e as lt,m as Ge,b as _,c as A,p as ut,g as dt,C as pt,d as me,S as ft,H as he,f as mt,T as ht,h as Oe,i as gt,L as xt,D as yt,U as J,E as bt,j as St,k as wt,P as jt,l as Mt,A as vt,n as _t,o as Ct,q as It,r as Pt,V as Et,B as At,R as we,O as Tt,s as Rt}from"./EditIcon-4fe4d562.js";import{O as te,Q as $,R as je,U as zt,W as Ue,X as Nt,Y as q,V as w,Z as D,_ as kt,$ as Gt,a0 as Ot,a1 as Ut,a2 as Lt,a3 as $t,a as I,u as x,a4 as Ft,a5 as Ht,a6 as X,a7 as Le,a8 as Bt,e as Vt,A as Wt,a9 as qt,aa as Xt,b as $e,ab as W,ac as Yt,ad as Zt,ae as Kt,af as re,ag as Fe,ah as Qt}from"./react-toastify.esm-33bde65a.js";import{q as ge}from"./generateCategoricalChart-1c1facbf.js";import{T as Jt}from"./index-1c25cb08.js";import{f as Dt,d as es}from"./index.esm-48f5a0db.js";import{P as ts}from"./PlusIcon-cd02e77b.js";import{u as ie}from"./index-4ed31db1.js";import{P as ss,O as ns}from"./index-12093467.js";import"./Popover-49edfbc6.js";import"./useSlotProps-64798079.js";import"./InfoIcon-2b7db8e3.js";import"./index-45e98739.js";import"./ClipLoader-bd3151f8.js";import"./NoFilterResultIcon-9b521a0b.js";import"./ChevronUpIcon-e8cb2ef3.js";import"./index-fad08197.js";import"./index-4bd9df61.js";import"./index-47ec6fb6.js";import"./index-ee15833b.js";import"./Popper-c505f1f7.js";import"./CheckIcon-1423c995.js";import"./SettingsIcon-9684ae93.js";import"./Stack-965c857a.js";const Me=e=>e===Object(e)&&!Array.isArray(e)&&typeof e!="function";function R(e,t){const d=pe(r=>r.gl),s=fe(te,Me(e)?Object.values(e):e);if(a.useLayoutEffect(()=>{t==null||t(s)},[t]),a.useEffect(()=>{(Array.isArray(s)?s:[s]).forEach(d.initTexture)},[d,s]),Me(e)){const r=Object.keys(e),o={};return r.forEach(n=>Object.assign(o,{[n]:s[r.indexOf(n)]})),o}else return s}R.preload=e=>fe.preload(te,e);R.clear=e=>fe.clear(te,e);$.func.isRequired,$.arrayOf($.oneOfType([$.element,$.func])).isRequired;const ve=new q,_e=new q,Z=[],F=new kt;class os extends zt{constructor(){super(),this.color=new Ue("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var t;return(t=this.instance.current)==null?void 0:t.geometry}raycast(t,d){const s=this.instance.current;if(!s||!s.geometry||!s.material)return;F.geometry=s.geometry;const r=s.matrixWorld,o=s.userData.instances.indexOf(this.instanceKey);if(!(o===-1||o>s.count)){s.getMatrixAt(o,ve),_e.multiplyMatrices(r,ve),F.matrixWorld=_e,s.material instanceof Nt?F.material.side=s.material.side:F.material.side=s.material[0].side,F.raycast(t,Z);for(let n=0,u=Z.length;n<u;n++){const c=Z[n];c.instanceId=o,c.object=this,d.push(c)}Z.length=0}}}const He=a.createContext(null),Ce=new q,Ie=new q,rs=new q,Pe=new w,Ee=new D,Ae=new w,Be=a.forwardRef(({context:e,children:t,...d},s)=>{a.useMemo(()=>lt({PositionMesh:os}),[]);const r=a.useRef(),{subscribe:o,getParent:n}=a.useContext(e||He);return a.useLayoutEffect(()=>o(r),[]),a.createElement("positionMesh",ue({instance:n(),instanceKey:r,ref:Ge([s,r])},d),t)}),is=a.forwardRef(({children:e,range:t,limit:d=1e3,frames:s=1/0,...r},o)=>{const[{context:n,instance:u}]=a.useState(()=>{const b=a.createContext(null);return{context:b,instance:a.forwardRef((j,v)=>a.createElement(Be,ue({context:b},j,{ref:v})))}}),c=a.useRef(null),[p,g]=a.useState([]),[[m,i]]=a.useState(()=>{const b=new Float32Array(d*16);for(let j=0;j<d;j++)rs.identity().toArray(b,j*16);return[b,new Float32Array([...new Array(d*3)].map(()=>1))]});a.useEffect(()=>{c.current.instanceMatrix.needsUpdate=!0});let h=0,f=0;_(()=>{if(s===1/0||h<s){c.current.updateMatrix(),c.current.updateMatrixWorld(),Ce.copy(c.current.matrixWorld).invert(),f=Math.min(d,t!==void 0?t:d,p.length),c.current.count=f,c.current.instanceMatrix.updateRange.count=f*16,c.current.instanceColor.updateRange.count=f*3;for(let b=0;b<p.length;b++){const j=p[b].current;j.matrixWorld.decompose(Pe,Ee,Ae),Ie.compose(Pe,Ee,Ae).premultiply(Ce),Ie.toArray(m,b*16),c.current.instanceMatrix.needsUpdate=!0,j.color.toArray(i,b*3),c.current.instanceColor.needsUpdate=!0}h++}});const S=a.useMemo(()=>({getParent:()=>c,subscribe:b=>(g(j=>[...j,b]),()=>g(j=>j.filter(v=>v.current!==b.current)))}),[]);return a.createElement("instancedMesh",ue({userData:{instances:p},matrixAutoUpdate:!1,ref:Ge([o,c]),args:[null,null,0],raycast:()=>null},r),a.createElement("instancedBufferAttribute",{attach:"instanceMatrix",count:m.length/16,array:m,itemSize:16,usage:je}),a.createElement("instancedBufferAttribute",{attach:"instanceColor",count:i.length/3,array:i,itemSize:3,usage:je}),typeof e=="function"?a.createElement(n.Provider,{value:S},e(u)):a.createElement(He.Provider,{value:S},e))}),as=(e,t,d,s,r)=>{const o=new Ot,n=1e-5;o.absarc(n,n,n,-Math.PI/2,-Math.PI,!0),o.absarc(n,t-s*2,n,Math.PI,Math.PI/2,!0),o.absarc(e-s*2,t-s*2,n,Math.PI/2,0,!0),o.absarc(e-s*2,n,n,0,-Math.PI/2,!0);const u=new Ut(o,{depth:d-s*2,bevelEnabled:!0,bevelSegments:r,steps:2,bevelSize:s,bevelThickness:s,curveSegments:r});u.center();const c=[],p=u.getAttribute("normal"),g=u.getAttribute("position");for(let m=0;m<g.count;m+=1){const i=new w(p.getX(m),p.getY(m),p.getZ(m)),h=new w(g.getX(m),g.getY(m),g.getZ(m));let f=0,S=0;Math.abs(i.y)>.9?(f=h.x/e+.5,S=1-(h.z/d+.5)):Math.abs(i.x)>.9?(f=-h.z/d+.5,S=1-(-h.y/t+.5)):Math.abs(i.z)>.9&&(f=h.x/e+.5,S=1-(-h.y/t+.5)),c.push(f,S)}return u.setAttribute("uv",new Lt(c,2)),u};as(10,10,10,2,10);const de=new Gt(10,10,10),Ve=e=>e.node_type==="topic"&&(e.scale||1)>5,cs=500,ls=800;let H=null;const us=500,xe=(e,t)=>{if(H)return null;H=setTimeout(()=>{H&&(clearTimeout(H),H=null)},us);const d=[];return e.forEach(r=>{const o=t.position.distanceTo($t.set(r.x,r.y,r.z));o<ls&&d.push({id:r.ref_id||"",distance:o})}),d.sort((r,o)=>r.distance-o.distance).slice(0,cs).map(r=>r.id)},E=new w(5e3,600,1600),Te=100,ds=600,ps=2e3,ae={x:172.7392402058252,y:-239.04675366094037,z:-2e3};let G,B;const fs=4e3,ms=2e3,hs=e=>{const t=I(),d=x(y=>y.cameraFocusTrigger),s=A(y=>y.isUserDragging),r=A(y=>y.isUserScrolling),o=A(y=>y.setUserMovedCamera),n=x(y=>y.setNearbyNodeIds),u=x(y=>y.showSelectionGraph),c=x(y=>y.data),p=x(y=>y.graphStyle),{camera:g}=pe(),[m,i]=a.useState(!1),[h,f]=a.useState(!1),[S,b]=a.useState(Te),j=a.useMemo(()=>{if(u)return new w(0,0,0);const y=c==null?void 0:c.nodes.find(T=>T.ref_id===(t==null?void 0:t.ref_id));let M=new w(2e3,2e3,3e3);if(y&&c){const T=c==null?void 0:c.nodes.filter(k=>{var Se;return(Se=y.children)==null?void 0:Se.find(tt=>tt===k.id)}),L=new w(y.x,y.y,y.z);let oe=new w(0,0,0);T.map(k=>(oe=oe.add(new w(k.x,k.y,k.z).normalize()),k));const De=y.scale?1-1/(y.scale+10):1,et=L.sub(oe).multiplyScalar(.8*De);M=L.add(et)}return M},[u,t,c]),v=a.useMemo(()=>{if(u)return new w(0,0,0);const y=c==null?void 0:c.nodes.find(M=>M.ref_id===(t==null?void 0:t.ref_id));return new w((y==null?void 0:y.x)||0,(y==null?void 0:y.y)||0,(y==null?void 0:y.z)||0)},[u,t,c]);a.useEffect(()=>{var y;u&&((y=e.current)==null||y.setLookAt(ae.x,ae.y,ae.z,0,0,0,!1)),ne()},[u]),a.useEffect(()=>{u?b(ps):(t==null?void 0:t.node_type)==="topic"?b(ds):b(Te)},[t,b,u]),a.useEffect(()=>{N()},[d]),a.useEffect(()=>{(s||r)&&(i(!0),f(!0))},[s,r,i,f]),a.useEffect(()=>{if(t)if(!u&&p==="earth"&&(e!=null&&e.current)){const y=e.current.camera.position.distanceTo(new w),M=Ft(v,-y/2);e.current.setLookAt(M.x,M.y,M.z,0,0,0,!0)}else G&&clearTimeout(G),G=setTimeout(()=>{f(!0),clearTimeout(G)},ms),ne();return()=>{G&&clearTimeout(G),B&&clearTimeout(B)}},[t]),_(y=>{e.current&&(m||Y(j,y.camera),h||U(v,y.camera))});const ne=()=>{if(t){const y=g.position.distanceTo(j);ut(y)}N()},N=()=>{i(!1),f(!1),o(!1),B&&clearTimeout(B),B=setTimeout(()=>{i(!0),f(!0)},fs)},Y=(y,M)=>{if(M.position.distanceTo(y)<S)i(!0);else{M.position.lerp(y,.5);const L=xe((c==null?void 0:c.nodes)||[],g);L&&n(L)}},U=(y,M)=>{var T;(T=e==null?void 0:e.current)==null||T.setLookAt(M.position.x,M.position.y,M.position.z,y.x,y.y,y.z,!0)};return null},gs=1;let P=null;const xs=(e,{enabled:t})=>{const d=I();hs(e);const s=A(g=>g.isUserDragging),r=x(g=>g.disableCameraRotation),o=x(g=>g.data),n=x(g=>g.graphStyle),u=x(g=>g.graphRadius),c=x(g=>g.setNearbyNodeIds);a.useEffect(()=>{t||(P==null||P.kill(),P=null)},[t]);const p=a.useCallback(()=>{P==null||P.kill();const g={value:-244},m=dt.to(g,{duration:5,keyframes:{"0%":{value:10},"100%":{delay:2,ease:"Power4.easeIn",value:-200}},onComplete:()=>{P=null},onInterrupt(){m.kill()},onUpdate:()=>{var h;const{value:i}=g;if(e.current){const f=xe((o==null?void 0:o.nodes)||[],e.current.camera);f&&c(f),(h=e.current)==null||h.dolly(i,!1)}}});m.play(),P=m},[]);return a.useEffect(()=>{e.current&&u&&(n==="sphere"?(e.current.maxDistance=8e3,e.current.minDistance=200,e.current.setTarget(0,0,500,!0)):(e.current.maxDistance=e.current.getDistanceToFitSphere(u+200),e.current.minDistance=100))},[u,n,e]),a.useEffect(()=>{p()},[p,n]),a.useEffect(()=>{!d&&e.current&&e.current.setLookAt(E.x,E.y,E.z,0,0,0,!0)},[d]),_((g,m)=>{e.current&&(!r&&!s&&(e.current.azimuthAngle+=gs*m*Ht.DEG2RAD),e.current.update(m))}),null},ys=({disableAnimations:e})=>{const t=a.useRef(null),d=x(i=>i.graphStyle),s=x(i=>i.data),r=x(i=>i.setNearbyNodeIds),o=x(i=>i.setDisableCameraRotation),[n]=a.useState(.8),{camera:u}=pe(),[c,p,g,m]=A(i=>[i.isUserDragging,i.setIsUserDragging,i.isUserScrolling,i.isUserScrollingOnHtmlPanel]);return xs(t,{enabled:!e&&!g&&!c}),a.useEffect(()=>{t.current&&t.current.setLookAt(E.x,E.y,E.z,0,0,0,!0)},[d]),a.useEffect(()=>{if(!c){const i=xe((s==null?void 0:s.nodes)||[],u);i&&r(i)}},[u,u.position,u.position.x,u.position.y,u.position.z,s==null?void 0:s.nodes,r,c]),a.useEffect(()=>{c&&o(!0)},[c,o]),l.jsx(pt,{ref:t,boundaryEnclosesCamera:!0,enabled:!m,makeDefault:!0,maxDistance:12e3,minDistance:100,onEnd:()=>p(!1),onStart:()=>p(!0),smoothTime:n})},se={metalness:.9,roughness:0},bs={...se},Ss=new X(bs),ws=({hide:e})=>{const t=ge(),d=x(r=>r.graphStyle),s=a.useMemo(()=>t.nodes.map((r,o)=>{if(r.node_type==="topic")return!1;const n=!Ve(r),u=me(r.node_type||"",!0);return l.jsx(Be,{color:u,name:r.id,position:[r.x,r.y,r.z],scale:n?(r.scale||1)*.9:0,userData:r},`${r.ref_id||r.id}-instanced-node-${o}-${d}`)}),[d,t]);return l.jsx(is,{geometry:de,material:Ss,visible:!e,children:s})},We=new te,ee=We.load("noimage.jpeg"),Re=new X({...se,map:ee}),qe=.4,js=new X({...se,map:ee,transparent:!0,opacity:qe}),K={},Ms=(e,t)=>{const[d,s]=a.useState(ee),[r,o]=a.useState(Re);return a.useEffect(()=>{const n=`${e}${t&&"-transparent"}`;if(K[n]){s(K[n].texture),o(K[n].material);return}We.load(e,u=>{const c=new X({map:u,transparent:t,opacity:t?qe:1,...se});K[n]={texture:u,material:c},s(u),o(c)},void 0,()=>{s(ee),o(t?js:Re)})},[e,t]),a.useEffect(()=>function(){d.dispose(),r.dispose()},[d,r]),r},ye=a.memo(({node:e,hide:t,animated:d})=>{const s=a.useRef(null),[r]=a.useState(de),o=I(),n=x(g=>g.showSelectionGraph),u=!!o&&e.ref_id===o.ref_id,c=Ms(e.image_url||"noimage.jpeg",!1);_((g,m)=>{d&&s.current&&(s.current.position.set(e.x,e.y,e.z),u&&(s.current.rotation.y+=m*1,s.current.rotation.x-=m*.6))}),a.useEffect(()=>function(){r.dispose()},[r]);const p=a.useMemo(()=>n&&u?20:u?(e.scale||1)*1.2:e.scale,[e,u,n]);return l.jsx(ft,{enabled:!!u,children:l.jsx("mesh",{ref:s,geometry:de,material:c,name:e.id,position:[e.x,e.y,e.z],scale:p,userData:e,visible:!t})})});ye.displayName="Cube";const vs=z(Ne)`
  text-align: center;
  width: ${e=>e.type==="topic"?"auto":`${e.size}px`};
  height: ${e=>e.type==="topic"?"auto":`${e.size}px`};
  outline: 1px solid ${e=>C.white};
  outline-offset: 0px;
  background: rgba(0, 0, 0, 0.75);
  color: ${e=>e.fontColor};
  border-radius: ${e=>`${e.type==="guest"?"100%":"6px"}`};
  font-size: ${e=>`${e.fontSize}px`};
  cursor: pointer;
  transition: font-size 0.4s, outline 0.4s;
  transform: scale(${e=>e.scale});
  align-items: center;
  justify-content: center;
  font-family: Barlow;
  font-size: 26px;
  font-style: normal;
  font-weight: 700;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);

  &:hover {
    outline-offset: 4px;
  }

  &.selected {
    .badge-wrapper {
      top: 0;
    }

    font-size: 36px;

    &:hover {
      outline-offset: 0px;
    }
  }

  &.topic {
    outline: none;
    background: none;
    &:hover {
      font-size: 36px;
    }
    white-space: nowrap;
    .badge-wrapper {
      display: none;
    }
  }

  .badge-wrapper {
    position: absolute;
    top: -7px;
    left: -14px;
  }
`;z.img`
  background-image: ${({src:e})=>`url(${e})`};
  background-size: contain;
  background-repeat: no-repeat;
  width: ${e=>e.size}px;
  height: ${e=>e.size}px;
  border-radius: ${e=>e.borderRadius};
`;z.div`
  display: flex;
  position: absolute;
  bottom: -14px;
  left: -5px;
  width: auto;
  justify-content: center;
  align-items: center;
`;z.div`
  display: flex;
  justify-content: center;
  align-items: center;
  background: ${C.transparentBlack};
  border: 2px solid ${e=>e.color};
  color: #fff;
  padding: 0 4px;
  min-width: 30px;
  height: 26px;
  font-size: 12px;
  font-weight: 500;
  border-radius: 6px;
  margin-right: 5px;
`;z.div`
  display: flex;
  justify-content: center;
  align-items: center;
  border: 2px solid ${e=>e.color}44;
  background: ${C.transparentBlack};
  padding: 0 4px;
  color: ${e=>e.color};
  min-width: 30px;
  height: 26px;
  font-size: 12px;
  font-weight: 500;
  border-radius: 6px;
  margin-right: 5px;
`;const _s=new w,Cs=({position:e,userData:t,color:d})=>{const s=a.useRef(null),[r,o]=x(h=>[h.selectedNode,h.setSelectedNode]),n=x(h=>h.setHoveredNode),u=x(h=>h.hoveredNode),c=x(h=>h.showSelectionGraph),p=((t==null?void 0:t.node_type)||"")==="topic",g=((t==null?void 0:t.node_type)||"")==="guest"||((t==null?void 0:t.node_type)||"")==="person";_(()=>{if(c&&s.current){const h=_s.set((t==null?void 0:t.x)||0,(t==null?void 0:t.y)||0,(t==null?void 0:t.z)||0);s.current.position.copy(h)}}),a.useEffect(()=>function(){s.current&&s.current.clear()},[s]);const m=a.useMemo(()=>(u==null?void 0:u.ref_id)===(t==null?void 0:t.ref_id),[u==null?void 0:u.ref_id,t==null?void 0:t.ref_id]),i=(r==null?void 0:r.ref_id)===(t==null?void 0:t.ref_id);return p||i&&c||!i?l.jsx("group",{ref:s,position:e,children:l.jsx(he,{center:!0,sprite:!0,zIndexRange:[0,0],children:l.jsxs(vs,{className:Vt(t==null?void 0:t.node_type,{selected:i}),color:d,fontColor:C.white,fontSize:p?64:20,onClick:h=>{h.stopPropagation(),t&&o(t)},onPointerOut:h=>{h.stopPropagation(),n(null)},onPointerOver:h=>{h.stopPropagation(),n(t||null)},scale:m?1.05:1,selected:!1,size:i?100:68,type:(t==null?void 0:t.node_type)||"",children:[!g&&!p?l.jsx("div",{className:"badge-wrapper",children:l.jsx(Jt,{type:(t==null?void 0:t.node_type)||""})}):null,p?t==null?void 0:t.label:l.jsx(Wt,{rounded:g,size:i?60:52,src:(t==null?void 0:t.image_url)||"audio_default.svg",type:t==null?void 0:t.node_type})]})})}):null},Xe=a.memo(()=>{const e=x(n=>n.data),t=I(),d=x(n=>n.showSelectionGraph),s=x(n=>n.selectionGraphData),r=x(n=>n.selectedNodeRelativeIds),o=a.useMemo(()=>(d?s.nodes:(e==null?void 0:e.nodes)||[]).filter(p=>r.includes((p==null?void 0:p.ref_id)||"")||(t==null?void 0:t.ref_id)===(p==null?void 0:p.ref_id)).slice(0,Le).map(p=>{const g=me(p.node_type||"",!0),m=new w((p==null?void 0:p.x)||0,(p==null?void 0:p.y)||0,(p==null?void 0:p.z)||0),i=((e==null?void 0:e.nodes)||[]).filter(h=>h.ref_id&&Bt(h,p)).map(h=>(h==null?void 0:h.ref_id)||"")||[];return l.jsx(Cs,{color:g,position:m,relativeIds:i,userData:p},`node-badge-${p.ref_id}`)}),[r,e==null?void 0:e.nodes,d,s,t]);return l.jsx(a.Fragment,{children:o.length?o:null},"node-badges")});Xe.displayName="RelevanceBadges";const Ye=({link:e,animated:t})=>{const d=a.useRef(null),s=I(),[r,o]=a.useState(new w(0,0,0)),[n,u]=a.useState(new w(0,0,0)),[c,p]=a.useState(8947848),g=x(m=>m.selectionGraphData);return a.useEffect(()=>{var h,f,S,b,j,v;const m=(s==null?void 0:s.ref_id)||"",i=s&&(m===e.targetRef||m===e.sourceRef);!e.onlyVisibleOnSelect||i?(o(new w(((h=e.sourcePosition)==null?void 0:h.x)||0,((f=e.sourcePosition)==null?void 0:f.y)||0,((S=e.sourcePosition)==null?void 0:S.z)||0)),u(new w(((b=e.targetPosition)==null?void 0:b.x)||0,((j=e.targetPosition)==null?void 0:j.y)||0,((v=e.targetPosition)==null?void 0:v.z)||0))):(o(new w(0,0,0)),u(new w(0,0,0))),p(i?e.color||ke.children.segmentColor:s?5592405:8947848)},[s,e]),_(()=>{if(t&&d.current){const m=g.nodes.find(h=>h.ref_id===e.sourceRef),i=g.nodes.find(h=>h.ref_id===e.targetRef);d.current.start.set((m==null?void 0:m.x)||0,(m==null?void 0:m.y)||0,(m==null?void 0:m.z)||0),d.current.end.set((i==null?void 0:i.x)||0,(i==null?void 0:i.y)||0,(i==null?void 0:i.z)||0)}}),l.jsx(mt,{ref:d,color:"0xFFFFFF",end:n,start:r})},Is={font:"/fonts/Inter-Bold.woff",characters:"abcdefghijklmnopqrstuvwxyz0123456789!",fontSize:2,letterSpacing:-.05,lineHeight:1,"material-toneMapped":!1},be=a.memo(({node:e,hide:t})=>{const d=a.useRef(null),s=I(),o=x(g=>g.selectedNodeRelativeIds).includes((e==null?void 0:e.ref_id)||""),n=!!s&&(s==null?void 0:s.id)===e.id,u=x(g=>g.showSelectionGraph);_(({camera:g})=>{d!=null&&d.current&&(d.current.quaternion.copy(g.quaternion),u&&d.current.position.set(e.x,e.y,e.z))});const c=a.useMemo(()=>{let g=(e.scale||1)*4;return u&&n?g=40:!n&&o&&(g=0),g},[e.scale,n,o,u]),p=a.useMemo(()=>s&&s.node_type==="topic"&&!n?.2:1,[n,s]);return l.jsx(ht,{ref:d,anchorX:"center",anchorY:"middle",color:C.white,fillOpacity:p,position:[e.x,e.y,e.z],scale:c,userData:e,visible:!t&&!n,...Is,children:e.label})});be.displayName="TextNode";let ce=null;const Ze=a.memo(()=>{const e=ge(),t=I(),d=x(o=>o.selectedNodeRelativeIds),s=x(o=>o.selectionGraphData),r=x(o=>o.setSelectionData);return a.useEffect(()=>{const o=e.nodes.filter(u=>u.ref_id===(t==null?void 0:t.ref_id)||d.includes((u==null?void 0:u.ref_id)||"")).map(u=>{const c=u.ref_id===(t==null?void 0:t.ref_id)&&u.node_type!=="topic"?{fx:0,fy:0,fz:0}:{};return{...u,x:0,y:0,z:0,...c}}),n=qt(o,!1,!1);r({nodes:o,links:n})},[e,t,d,r]),a.useEffect(()=>{ce=Xt(s.nodes,s.links,{numDimensions:2,forceLinkStrength:.01,forceCenterStrength:.85,forceChargeStrength:-20,velocityDecay:.9})},[s]),_(()=>{ce&&ce.tick()}),l.jsxs(l.Fragment,{children:[s==null?void 0:s.nodes.map(o=>o.node_type==="topic"?l.jsx(be,{hide:!0,node:o},`${o.ref_id||o.id}-compact`):l.jsx(ye,{animated:!0,hide:!0,node:o},`${o.ref_id||o.id}-compact`)),l.jsx(Oe,{fog:!0,lineWidth:.9,children:(s==null?void 0:s.links).map((o,n)=>l.jsx(Ye,{animated:!0,link:o},n.toString()))},`selection-links-${s==null?void 0:s.links.length}`)]})});Ze.displayName="SelectionDataNodes";const Ke=a.memo(()=>{const e=ge(),t=I(),d=x(i=>i.nearbyNodeIds),s=x(i=>i.setHoveredNode),r=x(i=>i.showSelectionGraph),o=x(i=>i.selectionGraphData),n=$e(i=>i.setTranscriptOpen),u=a.useCallback(i=>!!(r&&!o.nodes.find(h=>h.ref_id===i.ref_id)),[r,o]),c=a.useCallback(i=>{const h=i==null?void 0:i[0];h&&(n(!1),h.userData&&(u(h.userData)||x.getState().setSelectedNode((h==null?void 0:h.userData)||null)))},[n,u]),p=a.useCallback(i=>{i.stopPropagation(),s(null)},[s]),g=a.useCallback(i=>{var S;const f=i.intersections.map(b=>b.object)[0];if((S=f==null?void 0:f.userData)!=null&&S.ref_id){const b=f.userData;u(b)||(i.stopPropagation(),s(b))}},[s,u]),m=r&&!!t;return l.jsxs(gt,{filter:i=>i.filter(h=>{var f;return!!((f=h.userData)!=null&&f.id)}),onChange:c,onPointerOut:p,onPointerOver:g,children:[l.jsx(ws,{hide:m}),l.jsx(Xe,{}),e.nodes.filter(i=>{const h=(i==null?void 0:i.ref_id)===(t==null?void 0:t.ref_id);return d.includes(i.ref_id||"")||Ve(i)||h}).map(i=>i.node_type==="topic"?l.jsx(be,{hide:m,node:i},i.ref_id||i.id):l.jsx(ye,{hide:m,node:i},i.ref_id||i.id)),m&&l.jsx(Ze,{})]})});Ke.displayName="Cubes";const Ps={earthRef:null},Es=st(e=>({...Ps,setEarthRef:t=>e({earthRef:t})})),As=(e,t)=>{const d=new D().setFromUnitVectors(new w(0,1,0),e.clone().normalize()),s=new D().setFromUnitVectors(new w(0,1,0),t.clone().normalize()),r=new D,o=50,n=[];for(let c=0;c<=o;c+=1){const p=c/o;r.slerpQuaternions(d,s,p);const g=new w(0,1,0).applyQuaternion(r).multiplyScalar(W+Yt);n.push(g)}return new Zt(n).getPoints(o)},Ts=({link:e})=>{const t=I(),[d,s]=a.useState(8947848);a.useEffect(()=>{const o=(t==null?void 0:t.ref_id)||"",n=t&&(o===e.targetRef||o===e.sourceRef);s(n?e.color||ke.children.segmentColor:t?5592405:8947848)},[t,e]);const r=a.useMemo(()=>{var p,g,m,i,h,f;const o=(t==null?void 0:t.ref_id)||"",n=t&&(o===e.targetRef||o===e.sourceRef);if(!(!e.onlyVisibleOnSelect||n))return[];const u=new w(((p=e.sourcePosition)==null?void 0:p.x)||0,((g=e.sourcePosition)==null?void 0:g.y)||0,((m=e.sourcePosition)==null?void 0:m.z)||0),c=new w(((i=e.targetPosition)==null?void 0:i.x)||0,((h=e.targetPosition)==null?void 0:h.y)||0,((f=e.targetPosition)==null?void 0:f.z)||0);return As(u,c)},[e,t]);return r.length?l.jsx(xt,{color:d,dashed:!1,lineWidth:3,points:r}):null},Rs=new w(0,0,0),zs=()=>{const e=a.useRef(null),t=a.useRef(null),d=x(c=>c.graphStyle),s=x(c=>c.showSelectionGraph),r=x(c=>c.data),o=Es(c=>c.setEarthRef),n=R("textures/earth/galaxy.png"),u=R("textures/earth/clouds.png");return _(({camera:c})=>{t.current&&t.current.position.copy(c.getWorldPosition(Rs))}),a.useLayoutEffect(()=>{e.current&&o(e)},[o]),d!=="earth"||s?null:l.jsxs(l.Fragment,{children:[l.jsxs("mesh",{ref:e,userData:{type:"earth"},children:[l.jsx("sphereGeometry",{args:[W,200,200]}),l.jsx(Ns,{})]}),l.jsxs("mesh",{children:[l.jsx("sphereGeometry",{args:[W+2,200,200]}),l.jsx("meshStandardMaterial",{alphaMap:u,map:u,transparent:!0})]}),l.jsxs("mesh",{children:[l.jsx("sphereGeometry",{args:[W*4,200,200]}),l.jsx("meshStandardMaterial",{map:n,opacity:.4,side:Kt,transparent:!0})]}),l.jsx("directionalLight",{ref:t,intensity:.9,position:[0,0,W*3]}),r==null?void 0:r.links.map((c,p)=>l.jsx(Ts,{link:c},`curved-${p}`))]})},Ns=()=>{const e=R("textures/earth/earth.jpeg"),t=R("textures/earth/bump.jpeg"),d=R("textures/earth/water.png"),s=a.useMemo(()=>new X({map:e,bumpMap:t,aoMap:t,roughnessMap:t,metalnessMap:d,toneMapped:!0,roughness:35,metalness:0}),[e,t,d]);return l.jsx("meshStandardMaterial",{...s})},O=2e3,Q=J*4,ze=Object.values(yt).map(e=>e),ks=()=>{const e=a.useRef(null);_(()=>{var n,u,c,p,g;const r=(u=(n=e.current)==null?void 0:n.geometry.getAttribute("position"))==null?void 0:u.array,o=(p=(c=e.current)==null?void 0:c.geometry.getAttribute("velocity"))==null?void 0:p.array;if(r&&o){for(let m=0;m<r.length;m+=3){const i=r[m],h=r[m+1],f=r[m+2],S=o[m],b=o[m+1],j=o[m+2];r[m]+=S,r[m+1]+=b,r[m+2]+=j;const v=Math.sqrt(i*i+h*h+f*f);if(v*v>Q*Q){const N=Math.random()*Math.PI*2,Y=Math.random()*Math.PI*2,U=Math.random()*Q;r[m]=Math.sin(N)*Math.cos(Y)*U,r[m+1]=Math.sin(N)*Math.sin(Y)*U,r[m+2]=Math.cos(N)*U}}((g=e.current)==null?void 0:g.geometry.getAttribute("position")).needsUpdate=!0}});const t=a.useMemo(()=>new Float32Array(O*3),[]),d=a.useMemo(()=>new Float32Array(O*3),[]);a.useEffect(()=>{const r=Q;for(let o=0;o<O;o+=1){const n=o*3,u=Math.acos(1-o/O*2),c=Math.PI*2*o/O;t[n]=Math.sin(u)*Math.cos(c)*r,t[n+1]=Math.sin(u)*Math.sin(c)*r,t[n+2]=Math.cos(u)*r,d[n]=Math.random()-.5,d[n+1]=Math.random()-.5,d[n+2]=Math.random()-.5}},[t,d]);const s=a.useRef(null);return a.useEffect(()=>{s.current&&e.current&&(s.current.setAttribute("position",new re(t,3)),s.current.setAttribute("velocity",new re(d,3)),e.current.geometry=s.current)},[t,d]),a.useEffect(()=>{if(s.current){const r=[];for(let o=0;o<O;o+=1){const n=Math.floor(Math.random()*ze.length),u=ze[n],c=new Ue(u);c.multiplyScalar(2),r.push(c.r,c.g,c.b)}s.current.setAttribute("color",new re(new Float32Array(r),3))}},[]),l.jsxs("points",{ref:e,frustumCulled:!1,children:[l.jsx("bufferGeometry",{ref:s}),l.jsx("pointsMaterial",{opacity:.8,size:4,transparent:!0,vertexColors:!0})]})},V=e=>({close:{backgroundColor:"rgba(48, 51, 66, 1)",borderColor:"#fff",fontColor:"rgba(255, 255, 255, 1)"},focus:{backgroundColor:e?"rgba(255, 255, 255, 0.90);":"rgba(255, 255, 255, 0.90)",borderColor:e?"#FFDB58bb":"#fff",fontColor:"rgba(48, 51, 66, 1)"},menu:{backgroundColor:"#00000066",borderColor:e?"#ffffff66":"#5078f2",fontColor:e?"#ffffff66":"#fff"}}),Gs=new w,Qe=a.memo(()=>{const e=a.useRef(null),t=$e(f=>f.setSidebarOpen),{open:d}=ie("editNodeName"),{open:s}=ie("removeNode"),{open:r}=ie("addEdgeToNode"),[o]=nt(f=>[f.isAdmin]),n=x(f=>f.showSelectionGraph),u=x(f=>f.selectionGraphData),c=x(f=>f.data),p=I(),g=x(f=>f.setSelectedNode),m=x(f=>f.setShowSelectionGraph);_(()=>{i()});const i=a.useCallback(()=>{const f=n?u:c;if(e.current){const S=f==null?void 0:f.nodes.find(b=>b.ref_id===(p==null?void 0:p.ref_id));if(S){const b=Gs.set(S==null?void 0:S.x,S==null?void 0:S.y,S==null?void 0:S.z);e.current.position.copy(b)}}},[p,n,u,c]),h=a.useMemo(()=>{const f=o?[{key:"control-key-1",colors:V(n).focus,icon:l.jsx(ts,{}),left:-80,className:"add",onClick:()=>{r()}},{key:"control-key-2",colors:V(n).focus,icon:l.jsx(bt,{}),left:-40,className:"edit",onClick:()=>{d()}},{key:"control-key-3",colors:V(n).focus,icon:l.jsx(St,{}),left:0,className:"delete",onClick:()=>{s()}}]:[],S=[{key:"control-key-4",colors:V(n).focus,icon:l.jsx(Dt,{}),left:0,className:"expand",onClick:()=>{const b=!n;m(b),b&&t(!0)}},{key:"control-key-5",colors:V(!0).close,icon:l.jsx(es,{}),left:40,className:"exit",onClick:()=>{g(null),m(!1)}}];return[...f,...S].map((b,j)=>({...b,left:-80+j*40}))},[n,r,d,s,m,t,g,o]);return p?l.jsx("group",{ref:e,children:l.jsx(he,{center:!0,className:"control-panel",onClick:f=>f.stopPropagation(),onKeyDown:f=>f.stopPropagation(),onPointerDown:f=>f.stopPropagation(),onPointerOut:f=>f.stopPropagation(),onPointerOver:f=>f.stopPropagation(),onPointerUp:f=>f.stopPropagation(),sprite:!0,zIndexRange:[16777271,16777272],children:h.map(f=>l.jsx(Os,{backgroundColor:f.colors.backgroundColor,borderColor:f.colors.borderColor,className:f.className,fontColor:f.colors.fontColor,left:f.left,onClick:S=>{S.stopPropagation(),f.onClick()},children:f.icon},f.key))})}):null});Qe.displayName="NodeControls";const Os=z.div`
  position: fixed;
  top: -60px;
  left: ${e=>-7+e.left}px;
  width: 24px;
  height: 24px;

  border-radius: 40px;
  display: flex;
  justify-content: center;
  align-items: center;
  background: ${e=>e.backgroundColor?e.backgroundColor:"#000000bb"};
  color: ${e=>e.fontColor?e.fontColor:"#ffffff"};
  border-radius: 100%;
  font-size: 16px;
  cursor: pointer;
  transition: opacity 0.4s;
  box-shadow: 0px 2px 12px rgba(0, 0, 0, 0.5);
`,Je=a.memo(()=>l.jsx(l.Fragment,{children:l.jsx(Qe,{})}));Je.displayName="NodeDetailsPanel";const Us=()=>{const e=x(p=>p.data),t=x(p=>p.isFetching),d=x(p=>p.graphStyle),s=x(p=>p.showSelectionGraph),r=x(p=>p.selectedNodeRelativeIds),o=x(p=>p.selectionGraphData),n=x(p=>p.selectedNode),u=a.useMemo(()=>s?0:d==="force"?.2:.4,[s,d]),c=a.useMemo(()=>(s?o.nodes:(e==null?void 0:e.nodes)||[]).filter(i=>r.includes((i==null?void 0:i.ref_id)||"")||(n==null?void 0:n.ref_id)===(i==null?void 0:i.ref_id)).slice(0,Le).map(i=>{const h=new w(n==null?void 0:n.x,n==null?void 0:n.y,n==null?void 0:n.z),f=new w(i.x,i.y,i.z),S={source:n!=null&&n.id?n.id:"",target:i.id?i.id:"",targetRef:i.ref_id,sourceRef:n==null?void 0:n.ref_id,sourcePosition:h,targetPosition:f};return l.jsx(Ye,{link:S},i.id)}),[r,e==null?void 0:e.nodes,s,o,n]);return t?null:l.jsxs(l.Fragment,{children:[l.jsx(Ke,{}),l.jsx(zs,{}),l.jsx(ks,{}),d!=="earth"&&l.jsx(Oe,{fog:!0,limit:c.length,lineWidth:u,children:c},`links-${c.length}-${d}`),l.jsx(Je,{})]})},Ls=()=>{const{fogColor:e}=Fe("universe",{fogColor:it}),t=x(o=>o.graphStyle),d=a.useRef(null),s=a.useRef(null),r=a.useRef(null);return _(({camera:o,clock:n})=>{const u=n.getElapsedTime();if(d.current){const p=Math.sin(u/8)*1e3;d.current.position.setZ(p)}if(s.current&&s.current.position.lerp(o.position,.5),r.current){const c=u*.5,p=Math.sin(c)*J,g=Math.cos(c)*J;r.current.position.set(p,0,g)}}),l.jsxs(l.Fragment,{children:[l.jsx("hemisphereLight",{args:[C.white,ot,rt]}),t!=="earth"&&l.jsx("fog",{args:[e,5,18e3],attach:"fog"}),l.jsx("ambientLight",{color:C.white,intensity:1}),l.jsx("pointLight",{ref:s,color:C.white,distance:4e3,intensity:5,position:[0,0,0]}),l.jsx("directionalLight",{ref:r,color:C.white,intensity:8,position:[J,0,0]}),l.jsx("pointLight",{ref:d,color:C.white,distance:4e3,intensity:8,position:[0,0,0]})]})},$s=()=>l.jsx(he,{children:l.jsx(Ct,{})}),Fs=()=>{const{universeColor:e}=Fe("universe",{universeColor:C.black}),t=I(),d=a.useMemo(()=>t!=null&&t.node_type?me(t.node_type):Qt,[t]);return l.jsxs(l.Fragment,{children:[l.jsx("color",{args:[e],attach:"background"}),l.jsx(Ls,{}),l.jsx(ys,{}),l.jsxs(It,{children:[l.jsxs(Pt,{autoClear:!1,multisampling:8,children:[l.jsx(Et,{darkness:.7,eskil:!1,offset:.05}),l.jsx(At,{luminanceThreshold:1,mipmapBlur:!0,resolutionX:we.AUTO_SIZE,resolutionY:we.AUTO_SIZE}),l.jsx(Tt,{blendFunction:Rt.SCREEN,blur:!0,edgeStrength:4,hiddenEdgeColor:d,visibleEdgeColor:d})]}),l.jsx(Us,{})]})]})};let le=null;const Hs={aspect:window.innerWidth/window.innerHeight,far:3e4,near:1,position:[E.x,E.y,E.z]},Bs=()=>{const[e,t,d]=[A(n=>n.setIsUserScrollingOnHtmlPanel),A(n=>n.setIsUserScrolling),A(n=>n.setUserMovedCamera)],s=x(n=>n.isFetching),r=a.useCallback(n=>{var p;const{target:u}=n,{offsetParent:c}=u;le&&clearTimeout(le),(p=c==null?void 0:c.classList)!=null&&p.contains("html-panel")&&c.clientHeight<c.scrollHeight&&e(!0),t(!0),d(!0),le=setTimeout(()=>{t(!1),e(!1)},200)},[t,e,d]),o=a.useCallback(n=>at(n,"threeState"),[]);return l.jsxs(Vs,{children:[l.jsx(a.Suspense,{fallback:null,children:l.jsxs(wt,{camera:Hs,id:"universe-canvas",onCreated:o,onWheel:r,children:[ct&&l.jsx(jt,{position:"top-right"}),l.jsxs(a.Suspense,{fallback:l.jsx($s,{}),children:[l.jsx(Mt,{}),l.jsx(vt,{}),l.jsx(_t,{}),l.jsx(Fs,{})]})]})}),s&&l.jsx(ss,{fullSize:!1}),l.jsx(ns,{})]})},Vs=z(Ne)`
  flex: 1 1 100%;
  position: relative;
`,gn=a.memo(Bs);export{gn as Universe};
